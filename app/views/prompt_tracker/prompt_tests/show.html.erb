<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item"><%= link_to "Prompts", prompts_path %></li>
  <li class="breadcrumb-item"><%= link_to @prompt.name, prompt_path(@prompt) %></li>
  <li class="breadcrumb-item"><%= link_to "v#{@version.version_number}", prompt_prompt_version_path(@prompt, @version) %></li>
  <li class="breadcrumb-item"><%= link_to "Tests", prompt_prompt_version_prompt_tests_path(@prompt, @version) %></li>
  <li class="breadcrumb-item active"><%= @test.name %></li>
<% end %>

<%# Subscribe to Turbo Stream updates for this test %>
<%= turbo_stream_from "prompt_test_#{@test.id}" %>

<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-check2-square"></i> <%= @test.name %>
      <span class="badge bg-primary">v<%= @version.version_number %></span>
      <% unless @test.enabled? %>
        <span class="badge bg-secondary">Disabled</span>
      <% end %>
    </h1>
    <p class="text-muted"><%= @test.description %></p>
  </div>
  <div class="col-auto">
    <%= link_to edit_prompt_prompt_version_prompt_test_path(@prompt, @version, @test), class: "btn btn-outline-secondary me-2" do %>
      <i class="bi bi-pencil"></i> Edit
    <% end %>
    <%= button_to run_prompt_prompt_version_prompt_test_path(@prompt, @version, @test),
                  method: :post,
                  class: "btn btn-success",
                  data: { turbo_stream: true } do %>
      <i class="bi bi-play-circle"></i> Run Test
    <% end %>
  </div>
</div>

<!-- Test Stats -->
<div class="row mb-4">
  <div class="col-md-3">
    <%= render "test_status_card", test: @test %>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= number_to_percentage(@test.pass_rate, precision: 0) %></div>
      <div class="metric-label">
        Pass Rate
        <i class="bi bi-info-circle text-muted"
           data-bs-toggle="tooltip"
           data-bs-placement="top"
           title="Percentage of test runs that passed all evaluators and assertions"
           style="cursor: help;"></i>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= @recent_runs.count %></div>
      <div class="metric-label">Total Runs</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value">
        <% if @test.avg_execution_time.present? %>
          <%= number_to_human(@test.avg_execution_time, precision: 0) %>ms
        <% else %>
          N/A
        <% end %>
      </div>
      <div class="metric-label">Avg Duration</div>
    </div>
  </div>
</div>

<!-- Test Configuration -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Test Configuration</h5>
      </div>
      <div class="card-body">
        <h6>Template Variables</h6>
        <pre class="bg-light p-3 rounded"><code><%= JSON.pretty_generate(@test.template_variables) %></code></pre>

        <h6 class="mt-3">Model Configuration</h6>
        <pre class="bg-light p-3 rounded"><code><%= JSON.pretty_generate(@test.model_config) %></code></pre>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Evaluators</h5>
      </div>
      <div class="card-body">
        <% if @test.evaluator_configs.present? && @test.evaluator_configs.any? %>
          <% @test.evaluator_configs.each do |config| %>
            <div class="mb-3 p-3 border rounded">
              <h6><%= config["evaluator_key"] %></h6>
              <% if config["config"].present? %>
                <p class="mb-0"><strong>Config:</strong></p>
                <pre class="bg-light p-2 rounded mb-0"><code><%= JSON.pretty_generate(config["config"]) %></code></pre>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted">No evaluators configured</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Recent Test Runs -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">Recent Test Runs</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Run Time</th>
            <th>Version</th>
            <th>Status</th>
            <th class="text-end">Duration</th>
            <th class="text-end">Cost</th>
            <th>Evaluators</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="recent_runs_tbody">
          <% if @recent_runs.any? %>
            <% @recent_runs.each do |run| %>
              <%= render "test_run_row", run: run %>
            <% end %>
          <% else %>
            <tr id="no_runs_placeholder">
              <td colspan="7" class="text-center text-muted py-4">No test runs yet. Click "Run Test" to get started!</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
