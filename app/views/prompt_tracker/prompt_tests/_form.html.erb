<%= form_with(model: [@prompt, @version, @test], url: @test.new_record? ? prompt_prompt_version_prompt_tests_path(@prompt, @version) : prompt_prompt_version_prompt_test_path(@prompt, @version, @test), local: true) do |f| %>
  <% if @test.errors.any? %>
    <div class="alert alert-danger">
      <h5><%= pluralize(@test.errors.count, "error") %> prohibited this test from being saved:</h5>
      <ul class="mb-0">
        <% @test.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row">
    <div class="col-md-8">
      <!-- Basic Info -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Basic Information</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <%= f.label :name, class: "form-label" %>
            <%= f.text_field :name, class: "form-control", placeholder: "e.g., test_greeting_response" %>
          </div>

          <div class="mb-3">
            <%= f.label :description, class: "form-label" %>
            <%= f.text_area :description, class: "form-control", rows: 3, placeholder: "Describe what this test validates..." %>
          </div>

          <div class="mb-3">
            <%= f.label :enabled, class: "form-label" %>
            <div class="form-check">
              <%= f.check_box :enabled, class: "form-check-input" %>
              <%= f.label :enabled, "Enable this test", class: "form-check-label" %>
            </div>
          </div>
        </div>
      </div>

      <!-- Template Variables -->
      <div class="card mb-4" data-controller="template-variables">
        <div class="card-header">
          <h5 class="mb-0">Template Variables</h5>
        </div>
        <div class="card-body">
          <p class="text-muted small">Provide test values for the variables defined in this prompt version</p>

          <% if @version.variables_schema.present? %>
            <% current_vars = @test.template_variables || {} %>

            <% @version.variables_schema.each do |var| %>
              <% var_name = var["name"] || var[:name] %>
              <% var_type = var["type"] || var[:type] || "string" %>
              <% is_required = var["required"] || var[:required] %>
              <% current_value = current_vars[var_name] || current_vars[var_name.to_sym] %>

              <div class="mb-3">
                <label class="form-label">
                  <%= var_name %>
                  <% if is_required %>
                    <span class="badge bg-warning text-dark">required</span>
                  <% end %>
                  <small class="text-muted">(<%= var_type %>)</small>
                </label>

                <% case var_type %>
                <% when "string", "text" %>
                  <input type="text"
                         class="form-control"
                         data-template-variables-target="input"
                         data-var-name="<%= var_name %>"
                         data-var-type="string"
                         data-action="change->template-variables#updateJson input->template-variables#updateJson"
                         value="<%= current_value || "test_#{var_name}" %>"
                         placeholder="Enter <%= var_name %>">

                <% when "integer", "number" %>
                  <input type="number"
                         class="form-control"
                         data-template-variables-target="input"
                         data-var-name="<%= var_name %>"
                         data-var-type="number"
                         data-action="change->template-variables#updateJson input->template-variables#updateJson"
                         value="<%= current_value || 42 %>"
                         placeholder="Enter <%= var_name %>">

                <% when "boolean" %>
                  <select class="form-select"
                          data-template-variables-target="input"
                          data-var-name="<%= var_name %>"
                          data-var-type="boolean"
                          data-action="change->template-variables#updateJson">
                    <option value="true" <%= 'selected' if current_value == true || current_value == "true" %>>true</option>
                    <option value="false" <%= 'selected' if current_value == false || current_value == "false" %>>false</option>
                  </select>

                <% when "array" %>
                  <textarea class="form-control font-monospace"
                            data-template-variables-target="input"
                            data-var-name="<%= var_name %>"
                            data-var-type="array"
                            data-action="change->template-variables#updateJson input->template-variables#updateJson"
                            rows="3"
                            placeholder='["item1", "item2"]'><%= current_value.is_a?(Array) ? JSON.pretty_generate(current_value) : (current_value || "[]") %></textarea>
                  <small class="text-muted">Enter as JSON array</small>

                <% when "object" %>
                  <textarea class="form-control font-monospace"
                            data-template-variables-target="input"
                            data-var-name="<%= var_name %>"
                            data-var-type="object"
                            data-action="change->template-variables#updateJson input->template-variables#updateJson"
                            rows="4"
                            placeholder='{"key": "value"}'><%= current_value.is_a?(Hash) ? JSON.pretty_generate(current_value) : (current_value || "{}") %></textarea>
                  <small class="text-muted">Enter as JSON object</small>

                <% else %>
                  <input type="text"
                         class="form-control"
                         data-template-variables-target="input"
                         data-var-name="<%= var_name %>"
                         data-var-type="string"
                         data-action="change->template-variables#updateJson input->template-variables#updateJson"
                         value="<%= current_value || "test_value" %>"
                         placeholder="Enter <%= var_name %>">
                <% end %>
              </div>
            <% end %>

            <!-- Hidden field to store the JSON -->
            <%= f.hidden_field :template_variables, id: "template_variables_json", data: { template_variables_target: "hiddenField" } %>

          <% else %>
            <div class="alert alert-warning small mb-3">
              This prompt version has no variables defined.
            </div>
            <%= f.hidden_field :template_variables, value: "{}" %>
          <% end %>
        </div>
      </div>

      <!-- Expected Output -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Expected Output (Optional)</h5>
        </div>
        <div class="card-body">
          <p class="text-muted small">Exact text that the response should match (leave empty to skip exact match)</p>
          <%= f.text_area :expected_output, class: "form-control", rows: 4, placeholder: "Expected exact output..." %>
        </div>
      </div>

      <!-- Expected Patterns -->
      <div class="card mb-4" data-controller="patterns">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Expected Patterns (Optional)</h5>
          <button type="button" class="btn btn-sm btn-outline-primary" data-action="click->patterns#addPattern">
            <i class="bi bi-plus-circle"></i> Add Pattern
          </button>
        </div>
        <div class="card-body">
          <p class="text-muted small">Regex patterns that the response should match</p>

          <div data-patterns-target="list">
            <% current_patterns = @test.expected_patterns || [] %>
            <% if current_patterns.empty? %>
              <div class="text-muted text-center py-3" data-patterns-target="noMessage">
                <i class="bi bi-info-circle"></i> No patterns defined. Click "Add Pattern" to add one.
              </div>
            <% else %>
              <% current_patterns.each_with_index do |pattern, index| %>
                <div class="input-group mb-2 pattern-item">
                  <span class="input-group-text"><i class="bi bi-regex"></i></span>
                  <input type="text"
                         class="form-control"
                         data-patterns-target="input"
                         data-action="input->patterns#updateJson"
                         value="<%= pattern %>"
                         placeholder="e.g., /Hello/ or /\d{3}-\d{4}/">
                  <button type="button"
                          class="btn btn-outline-danger"
                          data-action="click->patterns#removePattern">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              <% end %>
            <% end %>
          </div>

          <!-- Hidden field to store the JSON -->
          <%= f.hidden_field :expected_patterns, id: "expected_patterns_json", data: { patterns_target: "hiddenField" } %>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <!-- Model Configuration -->
      <div class="card mb-4" data-controller="model-config">
        <div class="card-header">
          <h5 class="mb-0">Model Configuration</h5>
        </div>
        <div class="card-body">
          <p class="text-muted small">LLM model settings for this test</p>

          <% current_config = @test.model_config || { "provider" => "openai", "model" => "gpt-4", "temperature" => 0.7 } %>

          <div class="mb-3">
            <label class="form-label">Provider</label>
            <select class="form-select"
                    id="model_provider"
                    name="model_provider"
                    data-model-config-target="provider"
                    data-action="change->model-config#providerChanged">
              <option value="openai" <%= 'selected' if current_config["provider"] == "openai" %>>OpenAI</option>
              <option value="anthropic" <%= 'selected' if current_config["provider"] == "anthropic" %>>Anthropic</option>
              <option value="google" <%= 'selected' if current_config["provider"] == "google" %>>Google</option>
              <option value="azure" <%= 'selected' if current_config["provider"] == "azure" %>>Azure OpenAI</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Model</label>
            <select class="form-select"
                    id="model_name"
                    name="model_name"
                    data-model-config-target="model"
                    data-action="change->model-config#updateJson">
              <!-- OpenAI models -->
              <optgroup label="OpenAI"
                        id="openai_models"
                        data-model-config-target="modelGroup"
                        <%= 'style=display:none;' unless current_config["provider"] == "openai" %>>
                <option value="gpt-4" <%= 'selected' if current_config["model"] == "gpt-4" %>>GPT-4</option>
                <option value="gpt-4-turbo" <%= 'selected' if current_config["model"] == "gpt-4-turbo" %>>GPT-4 Turbo</option>
                <option value="gpt-3.5-turbo" <%= 'selected' if current_config["model"] == "gpt-3.5-turbo" %>>GPT-3.5 Turbo</option>
              </optgroup>
              <!-- Anthropic models -->
              <optgroup label="Anthropic"
                        id="anthropic_models"
                        data-model-config-target="modelGroup"
                        <%= 'style=display:none;' unless current_config["provider"] == "anthropic" %>>
                <option value="claude-3-opus" <%= 'selected' if current_config["model"] == "claude-3-opus" %>>Claude 3 Opus</option>
                <option value="claude-3-sonnet" <%= 'selected' if current_config["model"] == "claude-3-sonnet" %>>Claude 3 Sonnet</option>
                <option value="claude-3-haiku" <%= 'selected' if current_config["model"] == "claude-3-haiku" %>>Claude 3 Haiku</option>
              </optgroup>
              <!-- Google models -->
              <optgroup label="Google"
                        id="google_models"
                        data-model-config-target="modelGroup"
                        <%= 'style=display:none;' unless current_config["provider"] == "google" %>>
                <option value="gemini-pro" <%= 'selected' if current_config["model"] == "gemini-pro" %>>Gemini Pro</option>
                <option value="gemini-ultra" <%= 'selected' if current_config["model"] == "gemini-ultra" %>>Gemini Ultra</option>
              </optgroup>
              <!-- Azure models -->
              <optgroup label="Azure OpenAI"
                        id="azure_models"
                        data-model-config-target="modelGroup"
                        <%= 'style=display:none;' unless current_config["provider"] == "azure" %>>
                <option value="gpt-4" <%= 'selected' if current_config["model"] == "gpt-4" %>>GPT-4</option>
                <option value="gpt-35-turbo" <%= 'selected' if current_config["model"] == "gpt-35-turbo" %>>GPT-3.5 Turbo</option>
              </optgroup>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Temperature</label>
            <input type="number"
                   class="form-control"
                   id="model_temperature"
                   name="model_temperature"
                   data-model-config-target="temperature"
                   data-action="change->model-config#updateJson"
                   step="0.1" min="0" max="2" value="<%= current_config["temperature"] || 0.7 %>">
            <small class="text-muted">0 = deterministic, 2 = very creative</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Max Tokens (optional)</label>
            <input type="number"
                   class="form-control"
                   id="model_max_tokens"
                   name="model_max_tokens"
                   data-model-config-target="maxTokens"
                   data-action="change->model-config#updateJson"
                   value="<%= current_config["max_tokens"] %>" placeholder="Leave empty for default">
          </div>

          <!-- Hidden field to store the JSON -->
          <%= f.hidden_field :model_config, id: "model_config_json", data: { model_config_target: "hiddenField" } %>
        </div>
      </div>

      <!-- Evaluator Configs -->
      <div class="card mb-4" data-controller="evaluator-configs">
        <div class="card-header">
          <h5 class="mb-0">Evaluators (Optional)</h5>
        </div>
        <div class="card-body">
          <p class="text-muted small">Select evaluators to run for this test</p>

          <% available_evaluators = PromptTracker::EvaluatorRegistry.all %>
          <% current_evaluators = @test.evaluator_configs || [] %>

          <div id="evaluators-list">
            <% available_evaluators.each do |key, meta| %>
              <% existing_config = current_evaluators.find { |e| e["evaluator_key"] == key.to_s || e[:evaluator_key] == key } %>
              <% is_selected = existing_config.present? %>

              <div class="card mb-2 evaluator-item" data-evaluator-key="<%= key %>">
                <div class="card-body p-3">
                  <div class="form-check">
                    <input class="form-check-input"
                           type="checkbox"
                           id="evaluator_<%= key %>"
                           data-evaluator-key="<%= key %>"
                           data-evaluator-configs-target="checkbox"
                           data-action="change->evaluator-configs#toggleConfig"
                           <%= 'checked' if is_selected %>>
                    <label class="form-check-label" for="evaluator_<%= key %>">
                      <strong><i class="bi bi-<%= meta[:icon] %>"></i> <%= meta[:name] %></strong>
                      <br>
                      <small class="text-muted"><%= meta[:description] %></small>
                      <span class="badge bg-secondary"><%= meta[:category] %></span>
                    </label>
                  </div>

                  <div class="<%= 'collapse' unless is_selected %>"
                       id="config_<%= key %>"
                       data-evaluator-configs-target="config">
                    <div class="row mt-2">
                      <div class="col-md-6">
                        <label class="form-label small">Threshold (%)</label>
                        <input type="number"
                               class="form-control form-control-sm"
                               data-evaluator-key="<%= key %>"
                               data-evaluator-configs-target="threshold"
                               data-action="change->evaluator-configs#updateJson input->evaluator-configs#updateJson"
                               min="0" max="100"
                               value="<%= existing_config&.dig('threshold') || existing_config&.dig(:threshold) || 80 %>">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small">Weight</label>
                        <input type="number"
                               class="form-control form-control-sm"
                               data-evaluator-key="<%= key %>"
                               data-evaluator-configs-target="weight"
                               data-action="change->evaluator-configs#updateJson input->evaluator-configs#updateJson"
                               step="0.1" min="0" max="1"
                               value="<%= existing_config&.dig('weight') || existing_config&.dig(:weight) || 0.5 %>">
                      </div>
                    </div>

                    <% if meta[:config_schema].present? %>
                      <div class="mt-2">
                        <label class="form-label small">Configuration</label>
                        <div data-evaluator-key="<%= key %>"
                             data-evaluator-configs-target="configFormContainer">
                          <!-- Dynamic form will be loaded here -->
                          <div class="text-center py-2">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                              <span class="visually-hidden">Loading...</span>
                            </div>
                          </div>
                        </div>
                        <!-- Hidden field to store config JSON -->
                        <input type="hidden"
                               data-evaluator-key="<%= key %>"
                               data-evaluator-configs-target="configJson"
                               value='<%= JSON.generate(existing_config&.dig('config') || existing_config&.dig(:config) || meta[:default_config] || {}) %>'>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

          <!-- Hidden field to store the JSON -->
          <%= f.hidden_field :evaluator_configs, id: "evaluator_configs_json", data: { evaluator_configs_target: "hiddenField" } %>
        </div>
      </div>

      <!-- Tags -->
      <div class="card mb-4" data-controller="tags">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Tags (Optional)</h5>
          <button type="button" class="btn btn-sm btn-outline-primary" data-action="click->tags#addTag">
            <i class="bi bi-plus-circle"></i> Add Tag
          </button>
        </div>
        <div class="card-body">
          <p class="text-muted small">Tags for organizing and filtering tests</p>

          <div data-tags-target="list">
            <% current_tags = @test.tags || [] %>
            <% if current_tags.empty? %>
              <div class="text-muted text-center py-3" data-tags-target="noMessage">
                <i class="bi bi-info-circle"></i> No tags defined. Click "Add Tag" to add one.
              </div>
            <% else %>
              <% current_tags.each_with_index do |tag, index| %>
                <div class="input-group mb-2 tag-item">
                  <span class="input-group-text"><i class="bi bi-tag"></i></span>
                  <input type="text"
                         class="form-control"
                         data-tags-target="input"
                         data-action="input->tags#updateJson"
                         value="<%= tag %>"
                         placeholder="e.g., smoke, critical, regression">
                  <button type="button"
                          class="btn btn-outline-danger"
                          data-action="click->tags#removeTag">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              <% end %>
            <% end %>
          </div>

          <!-- Hidden field to store the JSON -->
          <%= f.hidden_field :tags, id: "tags_json", data: { tags_target: "hiddenField" } %>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between">
    <%= link_to "Cancel", @test.new_record? ? prompt_prompt_version_prompt_tests_path(@prompt, @version) : prompt_prompt_version_prompt_test_path(@prompt, @version, @test), class: "btn btn-outline-secondary" %>
    <%= f.submit @test.new_record? ? "Create Test" : "Update Test", class: "btn btn-primary" %>
  </div>
<% end %>
