<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item"><%= link_to "Prompts", prompts_path %></li>
  <li class="breadcrumb-item"><%= link_to @prompt.name, prompt_path(@prompt) %></li>
  <li class="breadcrumb-item"><%= link_to "v#{@version.version_number}", prompt_prompt_version_path(@prompt, @version) %></li>
  <li class="breadcrumb-item active">Tests</li>
<% end %>

<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-check2-square"></i> Tests for <%= @prompt.name %>
      <span class="badge bg-primary">v<%= @version.version_number %></span>
    </h1>
    <p class="text-muted">Automated tests for this specific version</p>
  </div>
  <div class="col-auto">
    <% if @tests.enabled.any? %>
      <%= button_to run_all_prompt_prompt_version_prompt_tests_path(@prompt, @version), method: :post, class: "btn btn-success me-2", data: { confirm: "Run all #{@tests.enabled.count} enabled tests?" } do %>
        <i class="bi bi-play-fill"></i> Run All Tests
      <% end %>
    <% end %>
    <%= link_to new_prompt_prompt_version_prompt_test_path(@prompt, @version), class: "btn btn-primary" do %>
      <i class="bi bi-plus-circle"></i> New Test
    <% end %>
  </div>
</div>

<!-- Test Stats -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= @tests.count %></div>
      <div class="metric-label">Total Tests</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= @tests.enabled.count %></div>
      <div class="metric-label">Enabled</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value">
        <% passing = @tests.select(&:passing?).count %>
        <%= passing %>/<%= @tests.count %>
      </div>
      <div class="metric-label">Passing</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value">
        <% if @tests.any? %>
          <%= number_to_percentage(@tests.sum { |t| t.pass_rate } / @tests.count, precision: 0) %>
        <% else %>
          N/A
        <% end %>
      </div>
      <div class="metric-label">
        Avg Pass Rate
        <i class="bi bi-info-circle text-muted"
           data-bs-toggle="tooltip"
           data-bs-placement="top"
           title="Percentage of test runs that passed all evaluators and assertions. Calculated across all historical runs for each test."
           style="cursor: help;"></i>
      </div>
    </div>
  </div>
</div>

<!-- Tests List -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">All Tests</h5>
  </div>
  <div class="card-body">
    <% if @tests.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Last Run</th>
              <th class="text-end">
                Pass Rate
                <i class="bi bi-info-circle text-muted"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   title="Percentage of test runs that passed all evaluators and assertions"
                   style="cursor: help;"></i>
              </th>
              <th class="text-end">Runs</th>
              <th>Tags</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @tests.each do |test| %>
              <tr>
                <td>
                  <strong><%= test.name %></strong>
                  <% unless test.enabled? %>
                    <span class="badge bg-secondary ms-2">Disabled</span>
                  <% end %>
                  <% if test.description.present? %>
                    <br><small class="text-muted"><%= truncate(test.description, length: 80) %></small>
                  <% end %>
                </td>
                <td>
                  <% if test.last_run %>
                    <% if test.passing? %>
                      <span class="badge bg-success">Passing</span>
                    <% else %>
                      <span class="badge bg-danger">Failing</span>
                    <% end %>
                  <% else %>
                    <span class="badge bg-secondary">Not Run</span>
                  <% end %>
                </td>
                <td>
                  <% if test.last_run %>
                    <%= time_ago_in_words(test.last_run.created_at) %> ago
                  <% else %>
                    <span class="text-muted">Never</span>
                  <% end %>
                </td>
                <td class="text-end">
                  <%= number_to_percentage(test.pass_rate, precision: 0) %>
                </td>
                <td class="text-end">
                  <%= test.prompt_test_runs.count %>
                </td>
                <td>
                  <% test.tags.each do |tag| %>
                    <span class="badge bg-info"><%= tag %></span>
                  <% end %>
                </td>
                <td>
                  <%= link_to "View", prompt_prompt_version_prompt_test_path(@prompt, @version, test), class: "btn btn-sm btn-outline-primary" %>
                  <%= link_to "Edit", edit_prompt_prompt_version_prompt_test_path(@prompt, @version, test), class: "btn btn-sm btn-outline-secondary" %>
                  <%= button_to "Run", run_prompt_prompt_version_prompt_test_path(@prompt, @version, test), method: :post, class: "btn btn-sm btn-outline-success", form: { style: "display: inline-block;" } %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-check2-square" style="font-size: 4rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No tests yet. Create your first test to get started!</p>
        <%= link_to new_prompt_prompt_version_prompt_test_path(@prompt, @version), class: "btn btn-primary" do %>
          <i class="bi bi-plus-circle"></i> Create First Test
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<script>
  // Initialize Bootstrap tooltips
  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });
</script>
