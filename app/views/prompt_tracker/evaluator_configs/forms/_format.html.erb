<%# Unified form for Format Evaluator - works for both test configuration and manual evaluation %>
<% existing_config ||= nil %>
<% config = existing_config&.config || {} %>
<% evaluator_key ||= 'format' %>
<% namespace ||= 'config' %>
<% expected_format = config['expected_format'] || config[:expected_format] || 'json' %>

<div class="alert alert-info mb-3">
  <i class="bi bi-file-code"></i>
  <strong>Format Validator</strong>
  <p class="mb-0 mt-1">Validates response format (JSON, Markdown, etc.). Binary pass/fail: valid format = pass.</p>
</div>

<!-- Hidden fields for evaluator type and context -->
<input type="hidden" name="evaluation[evaluator_type]" value="automated">
<input type="hidden" name="evaluation[evaluator_id]" value="<%= evaluator_key %>">
<input type="hidden" name="evaluation[evaluation_context]" value="manual">

<!-- Expected Format -->
<div class="mb-3">
  <label class="form-label">Expected Format</label>
  <select name="<%= namespace %>[expected_format]"
          class="form-select"
          id="<%= evaluator_key %>_format_select">
    <option value="json" <%= 'selected' if expected_format == 'json' %>>JSON</option>
    <option value="markdown" <%= 'selected' if expected_format == 'markdown' %>>Markdown</option>
    <option value="plain" <%= 'selected' if expected_format == 'plain' %>>Plain Text</option>
  </select>
  <small class="form-text text-muted">
    The format the response should be in.
  </small>
</div>

<!-- Strict Mode -->
<div class="mb-3">
  <div class="form-check">
    <input type="checkbox"
           name="<%= namespace %>[strict]"
           class="form-check-input"
           id="<%= evaluator_key %>_strict"
           value="true"
           <%= 'checked' if config['strict'] || config[:strict] %>>
    <label class="form-check-label" for="<%= evaluator_key %>_strict">
      Strict Validation
    </label>
    <small class="form-text text-muted d-block">
      If checked, validation will be more strict (e.g., for JSON, will check for proper structure).
    </small>
  </div>
</div>

<!-- Schema Validation (for JSON) -->
<div class="mb-3" id="<%= evaluator_key %>_schema_section" style="<%= 'display: none;' unless expected_format == 'json' %>">
  <label class="form-label">Schema Validation (Optional)</label>
  <textarea name="<%= namespace %>[schema]"
            class="form-control font-monospace"
            rows="8"
            placeholder='{"required_keys": ["status", "data"], "types": {"status": "string"}}'><%= (config['schema'] || config[:schema]).is_a?(Hash) ? JSON.pretty_generate(config['schema'] || config[:schema]) : (config['schema'] || config[:schema] || '') %></textarea>
  <small class="form-text text-muted">
    Define the expected JSON schema with required keys, optional keys, and types.
  </small>
</div>

<div class="alert alert-secondary">
  <strong>Binary Scoring:</strong>
  <ul class="mb-0 mt-2">
    <li>Valid format (passes validation): <strong>PASS (100 points)</strong></li>
    <li>Invalid format: <strong>FAIL (0 points)</strong></li>
  </ul>
</div>

<script>
  // Show/hide schema validation based on format selection
  document.addEventListener('DOMContentLoaded', function() {
    const formatSelect = document.getElementById('<%= evaluator_key %>_format_select');
    const schemaSection = document.getElementById('<%= evaluator_key %>_schema_section');

    function toggleSchemaSection() {
      if (formatSelect && schemaSection) {
        if (formatSelect.value === 'json') {
          schemaSection.style.display = 'block';
        } else {
          schemaSection.style.display = 'none';
        }
      }
    }

    if (formatSelect) {
      formatSelect.addEventListener('change', toggleSchemaSection);
      toggleSchemaSection(); // Initial state
    }
  });
</script>
