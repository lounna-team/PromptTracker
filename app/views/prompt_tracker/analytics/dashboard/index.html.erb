<% content_for :breadcrumbs do %>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Prompts", prompts_path %></li>
      <li class="breadcrumb-item active" aria-current="page">Analytics Dashboard</li>
    </ol>
  </nav>
<% end %>

<div class="mb-4">
  <h1><i class="bi bi-graph-up"></i> Analytics Dashboard</h1>
  <p class="text-muted">Overview of all LLM activity, costs, and performance metrics</p>
</div>

<!-- Quick Stats Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card border-primary">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1"><i class="bi bi-file-code"></i> Total Prompts</h6>
            <h2 class="mb-0"><%= @total_prompts %></h2>
          </div>
          <div class="text-primary" style="font-size: 2.5rem;">
            <i class="bi bi-file-code-fill"></i>
          </div>
        </div>
        <small class="text-muted"><%= @active_prompts %> active</small>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card border-success">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1"><i class="bi bi-chat-left-text"></i> Total Calls</h6>
            <h2 class="mb-0"><%= format_tokens(@total_responses) %></h2>
          </div>
          <div class="text-success" style="font-size: 2.5rem;">
            <i class="bi bi-chat-left-text-fill"></i>
          </div>
        </div>
        <small class="text-muted">
          <%= @successful_responses %> successful (<%= ((@successful_responses.to_f / @total_responses * 100).round(1) rescue 0) %>%)
        </small>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card border-warning">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1"><i class="bi bi-currency-dollar"></i> Total Cost</h6>
            <h2 class="mb-0"><%= format_cost(@total_cost) %></h2>
          </div>
          <div class="text-warning" style="font-size: 2.5rem;">
            <i class="bi bi-currency-dollar"></i>
          </div>
        </div>
        <small class="text-muted">Last 30 days: <%= format_cost(@cost_last_30_days) %></small>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card border-info">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="text-muted mb-1"><i class="bi bi-clock"></i> Avg Response</h6>
            <h2 class="mb-0"><%= format_duration(@avg_response_time) %></h2>
          </div>
          <div class="text-info" style="font-size: 2.5rem;">
            <i class="bi bi-clock-fill"></i>
          </div>
        </div>
        <small class="text-muted">Across all providers</small>
      </div>
    </div>
  </div>
</div>

<!-- Quick Links -->
<div class="row mb-4">
  <div class="col-md-12">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title mb-3"><i class="bi bi-speedometer2"></i> Quick Analytics</h5>
        <div class="d-flex gap-2 flex-wrap">
          <%= link_to analytics_costs_path, class: "btn btn-outline-primary" do %>
            <i class="bi bi-currency-dollar"></i> Cost Analysis
          <% end %>
          <%= link_to analytics_performance_path, class: "btn btn-outline-success" do %>
            <i class="bi bi-speedometer"></i> Performance Analysis
          <% end %>
          <%= link_to analytics_quality_path, class: "btn btn-outline-warning" do %>
            <i class="bi bi-star"></i> Quality Analysis
          <% end %>
          <%= link_to llm_responses_path, class: "btn btn-outline-info" do %>
            <i class="bi bi-chat-left-text"></i> All Responses
          <% end %>
          <%= link_to evaluations_path, class: "btn btn-outline-secondary" do %>
            <i class="bi bi-clipboard-check"></i> All Evaluations
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Activity Over Time -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Activity Last 30 Days</h5>
      </div>
      <div class="card-body">
        <% if @activity_by_day.any? %>
          <canvas id="activityChart" height="200"></canvas>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const ctx = document.getElementById('activityChart').getContext('2d');
              const data = <%= raw @activity_by_day.sort.to_h.to_json %>;
              
              new Chart(ctx, {
                type: 'line',
                data: {
                  labels: Object.keys(data),
                  datasets: [{
                    label: 'LLM Calls',
                    data: Object.values(data),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1,
                    fill: true
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { display: false }
                  },
                  scales: {
                    y: { beginAtZero: true }
                  }
                }
              });
            });
          </script>
        <% else %>
          <div class="text-center text-muted py-4">
            <i class="bi bi-graph-up" style="font-size: 3rem;"></i>
            <p class="mt-3">No activity in the last 30 days</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Provider Distribution</h5>
      </div>
      <div class="card-body">
        <% if @responses_by_provider.any? %>
          <canvas id="providerChart" height="200"></canvas>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const ctx = document.getElementById('providerChart').getContext('2d');
              const data = <%= raw @responses_by_provider.to_json %>;
              
              new Chart(ctx, {
                type: 'doughnut',
                data: {
                  labels: Object.keys(data),
                  datasets: [{
                    data: Object.values(data),
                    backgroundColor: [
                      'rgba(255, 99, 132, 0.8)',
                      'rgba(54, 162, 235, 0.8)',
                      'rgba(255, 206, 86, 0.8)',
                      'rgba(75, 192, 192, 0.8)',
                      'rgba(153, 102, 255, 0.8)'
                    ]
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { position: 'bottom' }
                  }
                }
              });
            });
          </script>
        <% else %>
          <div class="text-center text-muted py-4">
            <i class="bi bi-pie-chart" style="font-size: 3rem;"></i>
            <p class="mt-3">No provider data available</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Top Prompts by Usage -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-trophy"></i> Top Prompts by Usage</h5>
      </div>
      <div class="card-body">
        <% if @top_prompts_by_usage.any? %>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Prompt</th>
                  <th class="text-end">Calls</th>
                  <th class="text-end">Cost</th>
                </tr>
              </thead>
              <tbody>
                <% @top_prompts_by_usage.each do |prompt, count| %>
                  <tr>
                    <td><%= link_to prompt.name, prompt_path(prompt) %></td>
                    <td class="text-end"><%= format_tokens(count) %></td>
                    <td class="text-end"><%= format_cost(prompt.llm_responses.sum(:cost_usd)) %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center text-muted py-4">
            <p>No usage data available</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Top Prompts by Cost</h5>
      </div>
      <div class="card-body">
        <% if @top_prompts_by_cost.any? %>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Prompt</th>
                  <th class="text-end">Cost</th>
                  <th class="text-end">Calls</th>
                </tr>
              </thead>
              <tbody>
                <% @top_prompts_by_cost.each do |prompt, cost| %>
                  <tr>
                    <td><%= link_to prompt.name, prompt_path(prompt) %></td>
                    <td class="text-end"><%= format_cost(cost) %></td>
                    <td class="text-end"><%= format_tokens(prompt.llm_responses.count) %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center text-muted py-4">
            <p>No cost data available</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Recent Activity -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Activity</h5>
  </div>
  <div class="card-body">
    <% if @recent_responses.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Time</th>
              <th>Prompt</th>
              <th>Provider</th>
              <th>Model</th>
              <th>Status</th>
              <th class="text-end">Duration</th>
              <th class="text-end">Cost</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_responses.each do |response| %>
              <tr>
                <td><%= format_relative_time(response.created_at) %></td>
                <td><%= link_to response.prompt_version.prompt.name, prompt_path(response.prompt_version.prompt) %></td>
                <td><%= provider_icon(response.provider) %> <%= response.provider %></td>
                <td><code><%= response.model %></code></td>
                <td><%= status_badge(response.status) %></td>
                <td class="text-end"><%= format_duration(response.response_time_ms) %></td>
                <td class="text-end"><%= format_cost(response.cost_usd) %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <div class="text-center">
        <%= link_to "View All Responses", llm_responses_path, class: "btn btn-outline-primary" %>
      </div>
    <% else %>
      <div class="text-center text-muted py-4">
        <i class="bi bi-clock-history" style="font-size: 3rem;"></i>
        <p class="mt-3">No recent activity</p>
      </div>
    <% end %>
  </div>
</div>

