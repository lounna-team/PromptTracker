<% content_for :title, "Test Run ##{@test_run.id}" %>

<!-- Real-time updates via ActionCable -->
<% if @test_run.running? %>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Create ActionCable subscription for this test run
      const subscription = App.cable.subscriptions.create(
        {
          channel: "PromptTracker::TestRunChannel",
          test_run_id: <%= @test_run.id %>
        },
        {
          received(data) {
            console.log("Test run update received:", data);

            // Reload the page when test completes
            if (data.status === "passed" || data.status === "failed" || data.status === "error") {
              console.log("Test completed, reloading page...");
              window.location.reload();
            }
          },

          connected() {
            console.log("Connected to TestRunChannel for test run <%= @test_run.id %>");
          },

          disconnected() {
            console.log("Disconnected from TestRunChannel");
          }
        }
      );
    });
  </script>
<% end %>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><%= link_to "Test Runs", prompt_test_runs_path %></li>
    <li class="breadcrumb-item active">Run #<%= @test_run.id %></li>
  </ol>
</nav>

<!-- Header -->
<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-play-circle-fill"></i> Test Run #<%= @test_run.id %>
      <% if @test_run.running? %>
        <span class="badge bg-warning">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Running...
        </span>
      <% elsif @test_run.passed? %>
        <span class="badge bg-success">Passed</span>
      <% elsif @test_run.status == 'error' %>
        <span class="badge bg-danger">Error</span>
      <% else %>
        <span class="badge bg-danger">Failed</span>
      <% end %>
    </h1>
    <p class="text-muted">
      Test: <%= link_to @test.name, prompt_prompt_version_prompt_test_path(@test.prompt, @version, @test) %>
      | Version: <%= link_to "v#{@version.version_number}", prompt_prompt_version_path(@test.prompt, @version) %>
      | Run at: <%= @test_run.created_at.strftime("%B %d, %Y at %I:%M %p") %>
    </p>
  </div>
  <div class="col-auto">
    <%= link_to prompt_prompt_version_prompt_test_path(@test.prompt, @version, @test), class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left"></i> Back to Test
    <% end %>
  </div>
</div>

<!-- Stats -->
<div class="row mb-4">
  <div class="col-md-2">
    <div class="card metric-card">
      <div class="metric-value">
        <% if @test_run.running? %>
          <span class="text-warning">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Running
          </span>
        <% elsif @test_run.passed? %>
          <span class="text-success">✓ Passed</span>
        <% elsif @test_run.status == 'error' %>
          <span class="text-danger">✗ Error</span>
        <% else %>
          <span class="text-danger">✗ Failed</span>
        <% end %>
      </div>
      <div class="metric-label">Status</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card metric-card">
      <div class="metric-value"><%= @test_run.execution_time_ms %>ms</div>
      <div class="metric-label">Execution Time</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value">
        <span class="text-success"><%= @test_run.passed_evaluators || 0 %></span> /
        <span class="text-danger"><%= @test_run.failed_evaluators || 0 %></span>
      </div>
      <div class="metric-label">Evaluators (Pass/Fail)</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value">
        <%
          passed_assertions = @test_run.assertion_results&.count { |_, passed| passed } || 0
          failed_assertions = @test_run.assertion_results&.count { |_, passed| !passed } || 0
        %>
        <span class="text-success"><%= passed_assertions %></span> /
        <span class="text-danger"><%= failed_assertions %></span>
      </div>
      <div class="metric-label">Assertions (Pass/Fail)</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card metric-card">
      <div class="metric-value">
        <% if @test_run.cost_usd && @test_run.cost_usd > 0 %>
          $<%= number_with_precision(@test_run.cost_usd, precision: 4) %>
        <% elsif @llm_response&.cost_usd && @llm_response.cost_usd > 0 %>
          $<%= number_with_precision(@llm_response.cost_usd, precision: 4) %>
        <% else %>
          <span class="text-muted">-</span>
        <% end %>
      </div>
      <div class="metric-label">Cost</div>
    </div>
  </div>
</div>

<!-- Running Message -->
<% if @test_run.running? %>
  <div class="alert alert-info mb-4">
    <h5>
      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
      <i class="bi bi-hourglass-split"></i> Test Running
    </h5>
    <p class="mb-0">
      LLM response received. Evaluators are running in the background...
      <br>
      <small class="text-muted">This page will automatically update when the test completes.</small>
    </p>
  </div>
<% end %>

<!-- Error Message (if any) -->
<% if @test_run.error_message.present? %>
  <div class="alert alert-danger mb-4">
    <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
    <pre class="mb-0"><%= @test_run.error_message %></pre>
  </div>
<% end %>

<!-- LLM Response -->
<% if @llm_response %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">LLM Response</h5>
    </div>
    <div class="card-body">
      <h6>Rendered Prompt</h6>
      <pre class="bg-light p-3 rounded"><code><%= @llm_response.rendered_prompt %></code></pre>

      <h6 class="mt-3">Response</h6>
      <pre class="bg-light p-3 rounded"><code><%= @llm_response.response_text %></code></pre>

      <div class="row mt-3">
        <div class="col-md-6">
          <small class="text-muted">
            <strong>Provider:</strong> <%= @llm_response.provider %><br>
            <strong>Model:</strong> <%= @llm_response.model %>
          </small>
        </div>
        <div class="col-md-6 text-end">
          <small class="text-muted">
            <% if @llm_response.tokens_total %>
              <strong>Tokens:</strong> <%= @llm_response.tokens_total %>
              (<%= @llm_response.tokens_prompt %> prompt + <%= @llm_response.tokens_completion %> completion)
            <% end %>
          </small>
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- Evaluator Results -->
<% if @test_run.evaluator_results.present? && @test_run.evaluator_results.any? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Evaluator Results</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Evaluator</th>
              <th>Score</th>
              <th>Threshold</th>
              <th>Status</th>
              <th>Feedback</th>
            </tr>
          </thead>
          <tbody>
            <% @test_run.evaluator_results.each do |result| %>
              <%
                evaluator_key = (result["evaluator_key"] || result[:evaluator_key]).to_sym
                evaluator_meta = PromptTracker::EvaluatorRegistry.get(evaluator_key)
                evaluator_name = evaluator_meta ? evaluator_meta[:name] : evaluator_key.to_s.humanize
                evaluator_icon = evaluator_meta ? evaluator_meta[:icon] : "gear"
                evaluator_description = evaluator_meta ? evaluator_meta[:description] : ""
              %>
              <tr>
                <td>
                  <strong>
                    <i class="bi bi-<%= evaluator_icon %>"></i>
                    <%= evaluator_name %>
                  </strong>
                  <% if evaluator_description.present? %>
                    <br>
                    <small class="text-muted"><%= evaluator_description %></small>
                  <% end %>
                </td>
                <td>
                  <% score = result["score"] || result[:score] %>
                  <% if score %>
                    <strong><%= number_with_precision(score, precision: 2) %></strong>
                  <% else %>
                    <span class="text-muted">-</span>
                  <% end %>
                </td>
                <td>
                  <span class="text-muted"><%= result["threshold"] || result[:threshold] || 0 %></span>
                </td>
                <td>
                  <% if result["passed"] || result[:passed] %>
                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> Passed</span>
                  <% else %>
                    <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Failed</span>
                  <% end %>
                </td>
                <td>
                  <% feedback = result["feedback"] || result[:feedback] %>
                  <% error = result["error"] || result[:error] %>
                  <% if error %>
                    <div class="text-danger">
                      <i class="bi bi-exclamation-triangle"></i>
                      <strong>Error:</strong> <%= error %>
                    </div>
                  <% elsif feedback %>
                    <%= truncate(feedback, length: 150) %>
                  <% else %>
                    <span class="text-muted">No feedback</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% end %>

<!-- Assertion Results -->
<% if @test_run.assertion_results.present? && @test_run.assertion_results.any? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Assertion Results</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Assertion Type</th>
              <th>Details</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% @test_run.assertion_results.each do |name, passed| %>
              <tr>
                <td>
                  <strong>
                    <% if name == "expected_output" %>
                      <i class="bi bi-text-paragraph"></i> Exact Match
                    <% elsif name.start_with?("pattern_") %>
                      <i class="bi bi-regex"></i> Regex Pattern <%= name.gsub("pattern_", "#") %>
                    <% else %>
                      <%= name.humanize %>
                    <% end %>
                  </strong>
                </td>
                <td>
                  <% if name == "expected_output" && @test.expected_output.present? %>
                    <small class="text-muted">
                      Expected: <code><%= truncate(@test.expected_output, length: 100) %></code>
                    </small>
                  <% elsif name.start_with?("pattern_") %>
                    <% pattern_index = name.gsub("pattern_", "").to_i - 1 %>
                    <% if @test.expected_patterns && @test.expected_patterns[pattern_index] %>
                      <small class="text-muted">
                        Pattern: <code><%= @test.expected_patterns[pattern_index] %></code>
                      </small>
                    <% end %>
                  <% end %>
                </td>
                <td>
                  <% if passed %>
                    <span class="badge bg-success"><i class="bi bi-check-circle"></i> Passed</span>
                  <% else %>
                    <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Failed</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% end %>

<!-- Test Configuration -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Test Configuration</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <h6>Template Variables</h6>
        <pre class="bg-light p-3 rounded"><code><%= JSON.pretty_generate(@test.template_variables) %></code></pre>
      </div>
      <div class="col-md-6">
        <h6>Model Configuration</h6>
        <pre class="bg-light p-3 rounded"><code><%= JSON.pretty_generate(@test.model_config) %></code></pre>
      </div>
    </div>

    <% if @test.expected_output.present? %>
      <h6 class="mt-3">Expected Output</h6>
      <pre class="bg-light p-3 rounded"><code><%= @test.expected_output %></code></pre>
    <% end %>

    <% if @test.expected_patterns.present? && @test.expected_patterns.any? %>
      <h6 class="mt-3">Expected Patterns</h6>
      <ul>
        <% @test.expected_patterns.each do |pattern| %>
          <li><code><%= pattern %></code></li>
        <% end %>
      </ul>
    <% end %>
  </div>
</div>

<!-- Metadata -->
<% if @test_run.metadata.present? && @test_run.metadata.any? %>
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Run Metadata</h5>
    </div>
    <div class="card-body">
      <pre class="bg-light p-3 rounded mb-0"><code><%= JSON.pretty_generate(@test_run.metadata) %></code></pre>
    </div>
  </div>
<% end %>
