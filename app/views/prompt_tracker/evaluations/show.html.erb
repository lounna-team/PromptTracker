<% content_for :breadcrumbs do %>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Prompts", prompts_path %></li>
      <li class="breadcrumb-item"><%= link_to "Evaluations", evaluations_path %></li>
      <li class="breadcrumb-item active" aria-current="page">Evaluation #<%= @evaluation.id %></li>
    </ol>
  </nav>
<% end %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1><i class="bi bi-clipboard-check"></i> Evaluation #<%= @evaluation.id %></h1>
    <p class="text-muted">
      Evaluation for <%= link_to "Response ##{@response.id}", llm_response_path(@response) %>
    </p>
  </div>
  <%= link_to evaluations_path, class: "btn btn-outline-secondary" do %>
    <i class="bi bi-arrow-left"></i> Back to Evaluations
  <% end %>
</div>

<!-- Score Card -->
<div class="card mb-4 border-primary">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0"><i class="bi bi-star-fill"></i> Evaluation Score</h5>
  </div>
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-md-4 text-center">
        <% normalized_score = PromptTracker::EvaluationHelpers.normalize_score(
             @evaluation.score,
             min: @evaluation.score_min,
             max: @evaluation.score_max
           ) * 100 %>
        <div style="font-size: 4rem; font-weight: bold;">
          <%= score_badge(normalized_score, 0, 100) %>
        </div>
        <p class="text-muted mt-2">Normalized Score</p>
      </div>
      <div class="col-md-8">
        <table class="table table-sm mb-0">
          <tr>
            <th>Raw Score:</th>
            <td><strong><%= @evaluation.score %></strong></td>
          </tr>
          <tr>
            <th>Score Range:</th>
            <td><%= @evaluation.score_min %> - <%= @evaluation.score_max %></td>
          </tr>
          <tr>
            <th>Normalized:</th>
            <td><strong><%= normalized_score.round(1) %>%</strong></td>
          </tr>
          <tr>
            <th>Evaluator:</th>
            <td><span class="badge bg-secondary"><%= @evaluation.evaluator_name %></span></td>
          </tr>
          <tr>
            <th>Evaluator Class:</th>
            <td>
              <code class="text-muted small"><%= @evaluation.evaluator_type %></code>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Evaluation Details -->
<%
  # Derive template name from evaluator class name by convention
  # e.g., "PromptTracker::Evaluators::KeywordEvaluator" -> "keyword"
  template_name = @evaluation.evaluator_key.to_s

  # Build the template path
  template_path = "prompt_tracker/evaluators/templates/#{template_name}"
%>

<% if lookup_context.exists?(template_path, [], true) %>
  <%= render partial: template_path, locals: { evaluation: @evaluation } %>
<% elsif @evaluation.metadata.present? && @evaluation.metadata.any? %>
  <!-- Fallback: Raw Metadata Display -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-info-circle"></i> Evaluation Details</h5>
    </div>
    <div class="card-body">
      <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i>
        <strong>No template found for evaluator:</strong> <%= @evaluation.evaluator_name %> (<code><%= @evaluation.evaluator_type %></code>)
      </div>
      <pre class="bg-light p-3 rounded"><code><%= JSON.pretty_generate(@evaluation.metadata) %></code></pre>
    </div>
  </div>
<% end %>


<!-- Response Preview -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-file-text"></i> Response Preview</h5>
  </div>
  <div class="card-body">
    <% if @response.response_text.present? %>
      <div class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
        <%= simple_format(truncate(@response.response_text, length: 1000)) %>
      </div>
      <% if @response.response_text.length > 1000 %>
        <div class="mt-2">
          <%= link_to "View full response", llm_response_path(@response), class: "btn btn-sm btn-outline-primary" %>
        </div>
      <% end %>
    <% else %>
      <p class="text-muted mb-0">No response text available</p>
    <% end %>
  </div>
</div>

<!-- Other Evaluations for Same Response -->
<% other_evaluations = @response.evaluations.where.not(id: @evaluation.id) %>
<% if other_evaluations.any? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Other Evaluations for This Response</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>Evaluator</th>
              <th class="text-end">Score</th>
              <th>Feedback</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% other_evaluations.each do |eval| %>
              <% normalized = PromptTracker::EvaluationHelpers.normalize_score(
                   eval.score,
                   min: eval.score_min,
                   max: eval.score_max
                 ) * 100 %>
              <tr>
                <td><code>#<%= eval.id %></code></td>
                <td><span class="badge bg-secondary"><%= eval.evaluator_name %></span></td>
                <td><code class="text-muted small"><%= eval.evaluator_type %></code></td>
                <td class="text-end"><%= score_badge(normalized) %></td>
                <td><%= truncate(eval.feedback, length: 50) || "â€”" %></td>
                <td><%= format_relative_time(eval.created_at) %></td>
                <td>
                  <%= link_to evaluation_path(eval), class: "btn btn-sm btn-outline-primary" do %>
                    <i class="bi bi-eye"></i>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% end %>

<!-- Timestamps -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Timestamps</h5>
  </div>
  <div class="card-body">
    <table class="table table-sm mb-0">
      <tr>
        <th>Created:</th>
        <td><%= format_timestamp(@evaluation.created_at) %></td>
      </tr>
      <tr>
        <th>Updated:</th>
        <td><%= format_timestamp(@evaluation.updated_at) %></td>
      </tr>
    </table>
  </div>
</div>
