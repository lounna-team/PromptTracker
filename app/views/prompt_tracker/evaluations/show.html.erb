<% content_for :breadcrumbs do %>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Prompts", prompts_path %></li>
      <li class="breadcrumb-item"><%= link_to "Evaluations", evaluations_path %></li>
      <li class="breadcrumb-item active" aria-current="page">Evaluation #<%= @evaluation.id %></li>
    </ol>
  </nav>
<% end %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <div>
    <h1><i class="bi bi-clipboard-check"></i> Evaluation #<%= @evaluation.id %></h1>
    <p class="text-muted">
      Evaluation for <%= link_to "Response ##{@response.id}", llm_response_path(@response) %>
    </p>
  </div>
  <%= link_to evaluations_path, class: "btn btn-outline-secondary" do %>
    <i class="bi bi-arrow-left"></i> Back to Evaluations
  <% end %>
</div>

<!-- Score Card -->
<div class="card mb-4 border-primary">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0"><i class="bi bi-star-fill"></i> Evaluation Score</h5>
  </div>
  <div class="card-body">
    <div class="row align-items-center">
      <div class="col-md-4 text-center">
        <% normalized_score = PromptTracker::EvaluationHelpers.normalize_score(
             @evaluation.score,
             min: @evaluation.score_min,
             max: @evaluation.score_max
           ) * 100 %>
        <div style="font-size: 4rem; font-weight: bold;">
          <%= score_badge(normalized_score, 0, 100) %>
        </div>
        <p class="text-muted mt-2">Normalized Score</p>
      </div>
      <div class="col-md-8">
        <table class="table table-sm mb-0">
          <tr>
            <th>Raw Score:</th>
            <td><strong><%= @evaluation.score %></strong></td>
          </tr>
          <tr>
            <th>Score Range:</th>
            <td><%= @evaluation.score_min %> - <%= @evaluation.score_max %></td>
          </tr>
          <tr>
            <th>Normalized:</th>
            <td><strong><%= normalized_score.round(1) %>%</strong></td>
          </tr>
          <tr>
            <th>Evaluator Type:</th>
            <td><span class="badge bg-secondary"><%= @evaluation.evaluator_type %></span></td>
          </tr>
          <tr>
            <th>Evaluator ID:</th>
            <td>
              <% if @evaluation.evaluator_id.present? %>
                <%= @evaluation.evaluator_id %>
              <% else %>
                <span class="text-muted">Not specified</span>
              <% end %>
            </td>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Feedback -->
<% if @evaluation.feedback.present? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-chat-left-text"></i> Feedback</h5>
    </div>
    <div class="card-body">
      <div class="alert alert-info mb-0">
        <%= simple_format(@evaluation.feedback) %>
      </div>
    </div>
  </div>
<% end %>

<!-- Metadata -->
<% if @evaluation.metadata.present? && @evaluation.metadata.any? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-info-circle"></i> Metadata</h5>
    </div>
    <div class="card-body">
      <pre class="bg-light p-3 rounded"><code><%= JSON.pretty_generate(@evaluation.metadata) %></code></pre>
    </div>
  </div>
<% end %>

<!-- Related Response Details -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-chat-left-text"></i> Related LLM Response</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <table class="table table-sm">
          <tr>
            <th>Response ID:</th>
            <td><%= link_to "##{@response.id}", llm_response_path(@response) %></td>
          </tr>
          <tr>
            <th>Prompt:</th>
            <td><%= link_to @prompt.name, prompt_path(@prompt) %></td>
          </tr>
          <tr>
            <th>Version:</th>
            <td>
              <%= link_to "v#{@version.version_number}", prompt_prompt_version_path(@prompt, @version) %>
            </td>
          </tr>
          <tr>
            <th>Provider:</th>
            <td><%= provider_icon(@response.provider) %> <%= @response.provider %></td>
          </tr>
          <tr>
            <th>Model:</th>
            <td><code><%= @response.model %></code></td>
          </tr>
        </table>
      </div>
      <div class="col-md-6">
        <table class="table table-sm">
          <tr>
            <th>Status:</th>
            <td><%= status_badge(@response.status) %></td>
          </tr>
          <tr>
            <th>Response Time:</th>
            <td><%= format_duration(@response.response_time_ms) %></td>
          </tr>
          <tr>
            <th>Cost:</th>
            <td><%= format_cost(@response.cost_usd) %></td>
          </tr>
          <tr>
            <th>Tokens:</th>
            <td><%= format_tokens(@response.tokens_total) %></td>
          </tr>
          <tr>
            <th>Created:</th>
            <td><%= format_timestamp(@response.created_at) %></td>
          </tr>
        </table>
      </div>
    </div>

    <div class="mt-3">
      <%= link_to llm_response_path(@response), class: "btn btn-outline-primary" do %>
        <i class="bi bi-eye"></i> View Full Response
      <% end %>
    </div>
  </div>
</div>

<!-- Response Preview -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-file-text"></i> Response Preview</h5>
  </div>
  <div class="card-body">
    <% if @response.response_text.present? %>
      <div class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
        <%= simple_format(truncate(@response.response_text, length: 1000)) %>
      </div>
      <% if @response.response_text.length > 1000 %>
        <div class="mt-2">
          <%= link_to "View full response", llm_response_path(@response), class: "btn btn-sm btn-outline-primary" %>
        </div>
      <% end %>
    <% else %>
      <p class="text-muted mb-0">No response text available</p>
    <% end %>
  </div>
</div>

<!-- Other Evaluations for Same Response -->
<% other_evaluations = @response.evaluations.where.not(id: @evaluation.id) %>
<% if other_evaluations.any? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Other Evaluations for This Response</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>Evaluator</th>
              <th class="text-end">Score</th>
              <th>Feedback</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% other_evaluations.each do |eval| %>
              <% normalized = PromptTracker::EvaluationHelpers.normalize_score(
                   eval.score,
                   min: eval.score_min,
                   max: eval.score_max
                 ) * 100 %>
              <tr>
                <td><code>#<%= eval.id %></code></td>
                <td><span class="badge bg-secondary"><%= eval.evaluator_type %></span></td>
                <td><%= eval.evaluator_id || "—" %></td>
                <td class="text-end"><%= score_badge(normalized) %></td>
                <td><%= truncate(eval.feedback, length: 50) || "—" %></td>
                <td><%= format_relative_time(eval.created_at) %></td>
                <td>
                  <%= link_to evaluation_path(eval), class: "btn btn-sm btn-outline-primary" do %>
                    <i class="bi bi-eye"></i>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% end %>

<!-- Timestamps -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Timestamps</h5>
  </div>
  <div class="card-body">
    <table class="table table-sm mb-0">
      <tr>
        <th>Created:</th>
        <td><%= format_timestamp(@evaluation.created_at) %></td>
      </tr>
      <tr>
        <th>Updated:</th>
        <td><%= format_timestamp(@evaluation.updated_at) %></td>
      </tr>
    </table>
  </div>
</div>
