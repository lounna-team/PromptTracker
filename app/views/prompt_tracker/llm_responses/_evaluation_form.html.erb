<!-- Create Evaluation Card -->
<div class="card mb-4"
     data-controller="evaluator-form"
     data-evaluator-form-response-id-value="<%= @response.id %>">
  <div class="card-header">
    <h5 class="mb-0">
      <button class="btn btn-link text-decoration-none p-0 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#evaluationForm" aria-expanded="false" aria-controls="evaluationForm">
        <i class="bi bi-plus-circle"></i> Add New Evaluation
        <i class="bi bi-chevron-down float-end"></i>
      </button>
    </h5>
  </div>
  <div class="collapse" id="evaluationForm">
    <div class="card-body">
      <%= form_with model: PromptTracker::Evaluation.new, url: evaluations_path, method: :post, local: true, id: "newEvaluationForm" do |f| %>
        <%= f.hidden_field :llm_response_id, value: @response.id %>

        <!-- Evaluator Selection -->
        <div class="mb-3">
          <label class="form-label">Select Evaluator</label>
          <select id="evaluator_select"
                  name="evaluation[evaluator_id]"
                  class="form-select"
                  data-evaluator-form-target="select"
                  data-action="change->evaluator-form#loadForm">
            <option value="">Choose an evaluator...</option>

            <!-- All Evaluators from Registry -->
            <% PromptTracker::EvaluatorRegistry.all.each do |key, metadata| %>
              <option value="<%= key %>" data-evaluator-type="<%= metadata[:evaluator_type] %>">
                <% if metadata[:icon] %>
                  <i class="bi bi-<%= metadata[:icon] %>"></i>
                <% end %>
                <%= metadata[:name] %>
              </option>
            <% end %>
          </select>
          <small class="form-text text-muted">
            Choose an evaluator to run on this response.
          </small>
        </div>

        <!-- Dynamic Form Container (Turbo Frame) -->
        <turbo-frame id="evaluator_form_container">
          <div class="text-center py-4 text-muted">
            <i class="bi bi-arrow-up"></i>
            <p>Select an evaluator above to begin</p>
          </div>
        </turbo-frame>

        <!-- Submit Buttons -->
        <div class="d-flex gap-2 mt-3">
          <%= f.submit "Create Evaluation", class: "btn btn-primary", id: "submit_evaluation_btn" %>
          <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#evaluationForm">Cancel</button>
        </div>
      <% end %>
    </div>
  </div>
</div>
