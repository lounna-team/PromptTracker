<!-- Create Evaluation Card -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">
      <button class="btn btn-link text-decoration-none p-0 w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#evaluationForm" aria-expanded="false" aria-controls="evaluationForm">
        <i class="bi bi-plus-circle"></i> Add New Evaluation
        <i class="bi bi-chevron-down float-end"></i>
      </button>
    </h5>
  </div>
  <div class="collapse" id="evaluationForm">
    <div class="card-body">
      <%= form_with model: PromptTracker::Evaluation.new, url: evaluations_path, method: :post, local: true, id: "newEvaluationForm" do |f| %>
        <%= f.hidden_field :llm_response_id, value: @response.id %>

        <!-- Evaluator Selection -->
        <div class="mb-3">
          <label class="form-label">Select Evaluator</label>
          <select id="evaluator_select" class="form-select">
            <option value="">Choose an evaluator...</option>

            <!-- Manual Evaluation -->
            <option value="human" data-type="human">ðŸ‘¤ Human Review</option>
            <option value="llm_judge" data-type="llm_judge">ðŸ¤– LLM Judge</option>

            <!-- Registry Evaluators -->
            <% PromptTracker::EvaluatorRegistry.all.each do |key, metadata| %>
              <% next if metadata[:evaluator_type] == 'llm_judge' %> <!-- LLM Judge already listed above -->
              <option value="<%= key %>" data-type="registry">
                <% if metadata[:icon] %>
                  <i class="bi bi-<%= metadata[:icon] %>"></i>
                <% end %>
                <%= metadata[:name] %>
              </option>
            <% end %>
          </select>
          <small class="form-text text-muted">
            Choose a human review, LLM judge, or run a specific evaluator on this response.
          </small>
        </div>

        <!-- Dynamic Form Container -->
        <div id="dynamic_form_container">
          <!-- Form template will be loaded here via AJAX -->
          <div class="text-center py-4 text-muted">
            <i class="bi bi-arrow-up"></i>
            <p>Select an evaluator above to begin</p>
          </div>
        </div>

        <!-- Submit Buttons -->
        <div class="d-flex gap-2 mt-3">
          <%= f.submit "Create Evaluation", class: "btn btn-primary", id: "submit_evaluation_btn" %>
          <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#evaluationForm">Cancel</button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Dynamic form template loading for evaluator selection
  document.addEventListener('DOMContentLoaded', function() {
    const evaluatorSelect = document.getElementById('evaluator_select');
    const dynamicFormContainer = document.getElementById('dynamic_form_container');
    const llmResponseId = <%= @response.id %>;

    // Function to load form template via AJAX
    function loadFormTemplate(evaluatorValue, evaluatorType) {
      if (!dynamicFormContainer || !evaluatorValue) return;

      // Show loading spinner
      dynamicFormContainer.innerHTML = `
        <div class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading form...</span>
          </div>
        </div>
      `;

      // Determine the evaluator type for the form template
      let formType = evaluatorType;

      // Map evaluator types to form templates
      if (evaluatorType === 'registry') {
        formType = 'registry';
      }

      // Fetch the form template
      const url = `/prompt_tracker/evaluations/form_template?evaluator_type=${formType}&evaluator_key=${evaluatorValue}&llm_response_id=${llmResponseId}`;

      fetch(url)
        .then(response => {
          if (!response.ok) {
            throw new Error('Form template not found');
          }
          return response.text();
        })
        .then(html => {
          dynamicFormContainer.innerHTML = html;
        })
        .catch(error => {
          console.error('Error loading form template:', error);
          dynamicFormContainer.innerHTML = `
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-triangle"></i>
              Error loading form template. Please try again.
            </div>
          `;
        });
    }

    // Handle evaluator selection changes
    if (evaluatorSelect && dynamicFormContainer) {
      evaluatorSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
          const evaluatorValue = selectedOption.value;
          const evaluatorType = selectedOption.dataset.type;

          loadFormTemplate(evaluatorValue, evaluatorType);
        } else {
          // Reset to empty state
          dynamicFormContainer.innerHTML = `
            <div class="text-center py-4 text-muted">
              <i class="bi bi-arrow-up"></i>
              <p>Select an evaluator above to begin</p>
            </div>
          `;
        }
      });
    }
  });
</script>

