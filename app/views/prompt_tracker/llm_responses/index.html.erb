<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item active">Responses</li>
<% end %>

<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-chat-dots"></i> LLM Responses
      <span class="badge bg-secondary"><%= @responses.total_count %></span>
    </h1>
    <p class="text-muted">Browse all LLM API responses</p>
  </div>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: llm_responses_path, method: :get, local: true, class: "row g-3" do |f| %>
      <div class="col-md-3">
        <%= f.label :q, "Search", class: "form-label" %>
        <%= f.text_field :q, value: params[:q], class: "form-control", placeholder: "Search in prompts or responses..." %>
      </div>

      <div class="col-md-2">
        <%= f.label :provider, "Provider", class: "form-label" %>
        <%= f.select :provider, options_for_select([["All", ""]] + @providers.map { |p| [p, p] }, params[:provider]), {}, class: "form-select" %>
      </div>

      <div class="col-md-2">
        <%= f.label :model, "Model", class: "form-label" %>
        <%= f.select :model, options_for_select([["All", ""]] + @models.map { |m| [m, m] }, params[:model]), {}, class: "form-select" %>
      </div>

      <div class="col-md-2">
        <%= f.label :status, "Status", class: "form-label" %>
        <%= f.select :status, options_for_select([["All", ""]] + @statuses.map { |s| [s, s] }, params[:status]), {}, class: "form-select" %>
      </div>

      <div class="col-12">
        <%= f.submit "Apply Filters", class: "btn btn-primary" %>
        <%= link_to "Clear", llm_responses_path, class: "btn btn-outline-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Responses Table -->
<div class="card">
  <div class="card-body">
    <% if @responses.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>ID</th>
              <th>Prompt</th>
              <th>Version</th>
              <th>Provider</th>
              <th>Model</th>
              <th>Status</th>
              <th class="text-end">Tokens</th>
              <th class="text-end">Cost</th>
              <th class="text-end">Time</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @responses.each do |response| %>
              <tr>
                <td><code>#<%= response.id %></code></td>
                <td><%= link_to response.prompt_version.prompt.name, prompt_path(response.prompt_version.prompt) %></td>
                <td>
                  <%= link_to "v#{response.prompt_version.version_number}", prompt_prompt_version_path(response.prompt_version.prompt, response.prompt_version) %>
                </td>
                <td><%= provider_icon(response.provider) %> <%= response.provider %></td>
                <td><code><%= response.model %></code></td>
                <td><%= status_badge(response.status) %></td>
                <td class="text-end"><%= format_tokens(response.tokens_total) %></td>
                <td class="text-end"><%= format_cost(response.cost_usd) %></td>
                <td class="text-end"><%= format_duration(response.response_time_ms) %></td>
                <td><%= format_relative_time(response.created_at) %></td>
                <td>
                  <%= link_to "View", llm_response_path(response), class: "btn btn-sm btn-outline-primary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="mt-3">
        <%= paginate @responses %>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No responses found</p>
        <% if params[:q].present? || params[:provider].present? || params[:model].present? %>
          <%= link_to "Clear filters", llm_responses_path, class: "btn btn-outline-primary" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
