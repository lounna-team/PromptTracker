<% content_for :breadcrumbs do %>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Prompts", prompts_path %></li>
      <li class="breadcrumb-item"><%= link_to @prompt.name, prompt_path(@prompt) %></li>
      <li class="breadcrumb-item"><%= link_to "v#{@version.version_number}", prompt_prompt_version_path(@prompt, @version) %></li>
      <li class="breadcrumb-item active" aria-current="page">Response #<%= @response.id %></li>
    </ol>
  </nav>
<% end %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>
    <i class="bi bi-chat-left-text"></i>
    LLM Response #<%= @response.id %>
  </h1>
  <%= link_to prompt_prompt_version_path(@prompt, @version), class: "btn btn-outline-secondary" do %>
    <i class="bi bi-arrow-left"></i> Back to Version
  <% end %>
</div>

<!-- Response Details Card -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Response Details</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <table class="table table-sm">
          <tbody>
            <tr>
              <th style="width: 40%;">ID</th>
              <td><code>#<%= @response.id %></code></td>
            </tr>
            <tr>
              <th>Prompt</th>
              <td><%= link_to @prompt.name, prompt_path(@prompt) %></td>
            </tr>
            <tr>
              <th>Version</th>
              <td><%= link_to "v#{@version.version_number}", prompt_prompt_version_path(@prompt, @version) %></td>
            </tr>
            <tr>
              <th>Provider</th>
              <td><%= provider_icon(@response.provider) %> <%= @response.provider %></td>
            </tr>
            <tr>
              <th>Model</th>
              <td><code><%= @response.model %></code></td>
            </tr>
            <tr>
              <th>Status</th>
              <td><%= status_badge(@response.status) %></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="col-md-6">
        <table class="table table-sm">
          <tbody>
            <tr>
              <th style="width: 40%;">Response Time</th>
              <td><%= format_duration(@response.response_time_ms) %></td>
            </tr>
            <tr>
              <th>Tokens (Prompt)</th>
              <td><%= format_tokens(@response.tokens_prompt) %></td>
            </tr>
            <tr>
              <th>Tokens (Completion)</th>
              <td><%= format_tokens(@response.tokens_completion) %></td>
            </tr>
            <tr>
              <th>Tokens (Total)</th>
              <td><strong><%= format_tokens(@response.tokens_total) %></strong></td>
            </tr>
            <tr>
              <th>Cost</th>
              <td><strong><%= format_cost(@response.cost_usd) %></strong></td>
            </tr>
            <tr>
              <th>Created</th>
              <td><%= format_timestamp(@response.created_at) %></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <% if @response.user_id || @response.session_id || @response.environment %>
      <hr>
      <h6><i class="bi bi-tag"></i> Context</h6>
      <table class="table table-sm">
        <tbody>
          <% if @response.user_id %>
            <tr>
              <th style="width: 20%;">User ID</th>
              <td><code><%= @response.user_id %></code></td>
            </tr>
          <% end %>
          <% if @response.session_id %>
            <tr>
              <th>Session ID</th>
              <td><code><%= @response.session_id %></code></td>
            </tr>
          <% end %>
          <% if @response.environment %>
            <tr>
              <th>Environment</th>
              <td><span class="badge bg-info"><%= @response.environment %></span></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
</div>

<!-- Rendered Prompt Card -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-file-text"></i> Rendered Prompt</h5>
  </div>
  <div class="card-body">
    <% if @response.variables_used.present? %>
      <h6>Variables Used:</h6>
      <pre class="bg-light p-3 rounded"><%= JSON.pretty_generate(@response.variables_used) %></pre>
    <% end %>

    <h6 class="mt-3">Final Prompt Sent to LLM:</h6>
    <div class="bg-light p-3 rounded" style="white-space: pre-wrap; font-family: monospace;"><%= @response.rendered_prompt %></div>
  </div>
</div>

<!-- Response Text Card -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-chat-right-text"></i> LLM Response</h5>
  </div>
  <div class="card-body">
    <% if @response.status == "success" && @response.response_text.present? %>
      <div class="bg-light p-3 rounded" style="white-space: pre-wrap;"><%= @response.response_text %></div>

      <% if @response.response_metadata.present? %>
        <hr>
        <h6>Response Metadata:</h6>
        <pre class="bg-light p-3 rounded"><%= JSON.pretty_generate(@response.response_metadata) %></pre>
      <% end %>
    <% elsif @response.status == "error" || @response.status == "timeout" %>
      <div class="alert alert-danger">
        <h6><i class="bi bi-exclamation-triangle"></i> <%= @response.error_type || "Error" %></h6>
        <p class="mb-0"><%= @response.error_message %></p>
      </div>
    <% else %>
      <div class="alert alert-warning">
        <i class="bi bi-hourglass"></i> Response pending or no response text available.
      </div>
    <% end %>
  </div>
</div>

<!-- Evaluations -->
<%= render "prompt_tracker/shared/evaluations_table", evaluations: @evaluations, title: "Evaluations" %>

<!-- Additional Context Card -->
<% if @response.context.present? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0"><i class="bi bi-code-square"></i> Additional Context</h5>
    </div>
    <div class="card-body">
      <pre class="bg-light p-3 rounded"><%= JSON.pretty_generate(@response.context) %></pre>
    </div>
  </div>
<% end %>

<%= render "evaluation_form" %>
