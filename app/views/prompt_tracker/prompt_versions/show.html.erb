<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item"><%= link_to "Prompts", prompts_path %></li>
  <li class="breadcrumb-item"><%= link_to @prompt.name, prompt_path(@prompt) %></li>
  <li class="breadcrumb-item active">v<%= @version.version_number %></li>
<% end %>

<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-file-code"></i> <%= @prompt.name %>
      <span class="badge bg-primary">v<%= @version.version_number %></span>
      <%= status_badge(@version.status) %>
    </h1>
    <p class="text-muted"><%= @prompt.description %></p>
  </div>
  <div class="col-auto">
    <% unless @version.active? %>
      <%= button_to activate_prompt_prompt_version_path(@prompt, @version), method: :post, class: "btn btn-success me-2", data: { confirm: "Activate this version? This will deprecate all other versions." } do %>
        <i class="bi bi-check-circle"></i> Activate Version
      <% end %>
    <% end %>
    <%= link_to prompt_prompt_version_playground_path(@prompt, @version), class: "btn btn-primary me-2" do %>
      <i class="bi bi-play-circle"></i> Test in Playground
    <% end %>
    <%= link_to prompt_prompt_version_prompt_tests_path(@prompt, @version), class: "btn btn-outline-primary me-2" do %>
      <i class="bi bi-check2-square"></i> Tests
    <% end %>
    <%= link_to compare_prompt_prompt_version_path(@prompt, @version), class: "btn btn-outline-info" do %>
      <i class="bi bi-arrow-left-right"></i> Compare Versions
    <% end %>
  </div>
</div>

<!-- Metrics -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= format_tokens(@total_calls) %></div>
      <div class="metric-label">Total Calls</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= format_cost(@total_cost) %></div>
      <div class="metric-label">Total Cost</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= format_duration(@avg_response_time) %></div>
      <div class="metric-label">Avg Response Time</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value">
        <% if @avg_score %>
          <%= @avg_score.round(2) %>
        <% else %>
          <span class="text-muted">N/A</span>
        <% end %>
      </div>
      <div class="metric-label">Avg Quality Score</div>
    </div>
  </div>
</div>

<!-- Version Details -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Version Details</h5>
      </div>
      <div class="card-body">
        <table class="table table-sm">
          <tbody>
            <tr>
              <th style="width: 40%;">Version Number</th>
              <td><strong>v<%= @version.version_number %></strong></td>
            </tr>
            <tr>
              <th>Status</th>
              <td><%= status_badge(@version.status) %></td>
            </tr>
            <tr>
              <th>Source</th>
              <td><%= source_badge(@version.source) %></td>
            </tr>
            <tr>
              <th>Created</th>
              <td><%= format_timestamp(@version.created_at) %></td>
            </tr>
            <tr>
              <th>Updated</th>
              <td><%= format_timestamp(@version.updated_at) %></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Usage Breakdown</h5>
      </div>
      <div class="card-body">
        <h6>By Provider</h6>
        <% if @responses_by_provider.any? %>
          <% @responses_by_provider.each do |provider, count| %>
            <div class="d-flex justify-content-between mb-2">
              <span><%= provider_icon(provider) %> <%= provider %></span>
              <span class="badge bg-secondary"><%= count %></span>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted">No responses yet</p>
        <% end %>

        <h6 class="mt-3">By Status</h6>
        <% if @responses_by_status.any? %>
          <% @responses_by_status.each do |status, count| %>
            <div class="d-flex justify-content-between mb-2">
              <span><%= status_badge(status) %></span>
              <span class="badge bg-secondary"><%= count %></span>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted">No responses yet</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Template -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Template</h5>
  </div>
  <div class="card-body">
    <pre><code><%= @version.template %></code></pre>
  </div>
</div>

<!-- Variables Schema -->
<% if @version.variables_schema.present? && @version.variables_schema.any? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Variables Schema</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Variable</th>
              <th>Type</th>
              <th>Required</th>
              <th>Description</th>
            </tr>
          </thead>
          <tbody>
            <% @version.variables_schema.each do |var| %>
              <tr>
                <td><code>{{ <%= var["name"] %> }}</code></td>
                <td><span class="badge bg-info"><%= var["type"] %></span></td>
                <td>
                  <% if var["required"] %>
                    <span class="badge bg-danger">Required</span>
                  <% else %>
                    <span class="badge bg-secondary">Optional</span>
                  <% end %>
                </td>
                <td><%= var["description"] %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% end %>

<!-- Model Config -->
<% if @version.model_config.present? && @version.model_config.any? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Model Configuration</h5>
    </div>
    <div class="card-body">
      <pre><code><%= JSON.pretty_generate(@version.model_config) %></code></pre>
    </div>
  </div>
<% end %>

<!-- Auto-Evaluators Configuration -->
<div class="row mb-4">
  <div class="col-12">
    <%= render "evaluator_configs" %>
  </div>
</div>

<!-- Evaluator Modals (outside card to avoid z-index issues) -->
<%= render "evaluator_modals" %>

<!-- Tests -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Tests</h5>
    <div>
      <span class="badge bg-secondary me-2"><%= @tests.count %> tests</span>
      <%= link_to "New Test", new_prompt_prompt_version_prompt_test_path(@prompt, @version), class: "btn btn-sm btn-primary" %>
    </div>
  </div>
  <div class="card-body">
    <% if @tests.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Test Name</th>
              <th>Last Status</th>
              <th>Last Run</th>
              <th class="text-end">Pass Rate</th>
              <th class="text-end">Total Runs</th>
              <th>Tags</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @tests.each do |test| %>
              <%= render "prompt_tracker/prompt_tests/test_row", test: test, prompt: @prompt, version: @version %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-clipboard-check" style="font-size: 3rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No tests yet for this version</p>
        <p class="text-muted">Tests help you validate prompt behavior before deploying to production.</p>
        <%= link_to "Create Your First Test", new_prompt_prompt_version_prompt_test_path(@prompt, @version), class: "btn btn-primary mt-2" %>
      </div>
    <% end %>
  </div>
</div>
