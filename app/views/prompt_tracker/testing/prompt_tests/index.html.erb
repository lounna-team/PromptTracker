<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item"><%= link_to "Prompts", testing_prompts_path %></li>
  <li class="breadcrumb-item"><%= link_to "v#{@version.version_number}", testing_prompt_prompt_version_path(@prompt, @version) %></li>
  <li class="breadcrumb-item active">Tests</li>
<% end %>

<%# Subscribe to Turbo Stream updates for this prompt version %>
<%= turbo_stream_from "prompt_version_#{@version.id}" %>

<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-check2-square"></i> Tests for <%= @prompt.name %>
      <span class="badge bg-primary">v<%= @version.version_number %></span>
    </h1>
    <p class="text-muted">Automated tests for this specific version</p>
  </div>
  <div class="col-auto">
    <% if @tests.enabled.any? %>
      <%= button_to run_all_testing_prompt_prompt_version_prompt_tests_path(@prompt, @version), method: :post, class: "btn btn-success me-2", data: { confirm: "Run all #{@tests.enabled.count} enabled tests?" } do %>
        <i class="bi bi-play-fill"></i> Run All Tests
      <% end %>
    <% end %>
    <%= link_to new_testing_prompt_prompt_version_prompt_test_path(@prompt, @version), class: "btn btn-primary" do %>
      <i class="bi bi-plus-circle"></i> New Test
    <% end %>
  </div>
</div>

<!-- Test Stats -->
<div class="row mb-4">
  <div class="col-md-3">
    <%= render "overall_status_card", tests: @tests %>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= @tests.count %></div>
      <div class="metric-label">Total Tests</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= @tests.enabled.count %></div>
      <div class="metric-label">Enabled</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value">
        <% passing = @tests.select(&:passing?).count %>
        <%= passing %>/<%= @tests.count %>
      </div>
      <div class="metric-label">Passing</div>
    </div>
  </div>
</div>

<!-- Tests List -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">All Tests</h5>
  </div>
  <div class="card-body">
    <% if @tests.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Name</th>
              <th>
                Status
                <i class="bi bi-info-circle text-muted"
                   data-bs-toggle="tooltip"
                   data-bs-placement="top"
                   title="Status of the latest test run for this test"
                   style="cursor: help;"></i>
              </th>
              <th>Last Run</th>
              <th class="text-end">Runs</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @tests.each do |test| %>
              <%= render "test_row", test: test, prompt: @prompt, version: @version %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-check2-square" style="font-size: 4rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No tests yet. Create your first test to get started!</p>
        <%= link_to new_testing_prompt_prompt_version_prompt_test_path(@prompt, @version), class: "btn btn-primary" do %>
          <i class="bi bi-plus-circle"></i> Create First Test
        <% end %>
      </div>
    <% end %>
  </div>
</div>
