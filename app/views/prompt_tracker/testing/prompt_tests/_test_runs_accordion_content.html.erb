<% latest_runs = test.prompt_test_runs.includes(:human_evaluations, llm_response: :evaluations).order(created_at: :desc).limit(5) %>
<% total_count = test.prompt_test_runs.count %>
<% version = test.prompt_version %>
<% prompt = version.prompt %>

<% if latest_runs.any? %>
  <div class="bg-light p-3" data-controller="column-visibility" data-column-visibility-storage-key-value="testRunsTableColumns_<%= test.id %>">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="mb-0">
        <i class="bi bi-clock-history"></i>
        Latest Test Runs (<span id="loaded-runs-count-<%= test.id %>">5</span> of <%= total_count %>)
      </h6>
      <%= render "prompt_tracker/testing/prompt_tests/test_runs_column_visibility_dropdown", test: test %>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-bordered bg-white mb-0">
        <thead>
          <tr>
            <th style="width: 10%;" data-column="run_status">Status</th>
            <th style="width: 12%;" data-column="run_time">Run Time</th>
            <th style="width: 10%;" data-column="response_time">Response Time</th>
            <th style="width: 8%;" data-column="run_cost">Cost</th>
            <th style="width: 20%;" data-column="rendered_prompt">Rendered Prompt</th>
            <th style="width: 20%;" data-column="run_response">Response</th>
            <th style="width: 10%;" data-column="run_evaluations">Evaluations</th>
            <th style="width: 10%;" data-column="human_evaluations">Human Evaluations</th>
            <th style="width: 5%;" data-column="actions">Actions</th>
          </tr>
        </thead>
        <tbody id="test-runs-tbody-<%= test.id %>">
          <% latest_runs.each do |run| %>
            <%= render "prompt_tracker/testing/prompt_tests/test_run_row", run: run %>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- Load More Section -->
    <div id="load-more-runs-<%= test.id %>">
      <% if total_count > 5 %>
        <div class="text-center mt-3">
          <%= link_to load_more_runs_testing_prompt_prompt_version_prompt_test_path(prompt, version, test, offset: 5, limit: 5),
                      class: "btn btn-sm btn-outline-primary",
                      data: { turbo_stream: true } do %>
            <i class="bi bi-arrow-down-circle"></i> Load 5 More Runs
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Human Evaluation Modals -->
    <div id="test-runs-modals-<%= test.id %>">
      <% latest_runs.each do |run| %>
        <%= render "prompt_tracker/shared/human_evaluation_modal",
                   record: run,
                   form_url: testing_run_human_evaluations_path(run),
                   context: 'testing' %>
        <%= render "prompt_tracker/testing/prompt_tests/all_human_evaluations_modal",
                   run: run %>
      <% end %>
    </div>
  </div>
<% else %>
  <div class="bg-light p-3">
    <p class="text-muted mb-0"><i class="bi bi-info-circle"></i> No test runs yet. Click "Run Test" to execute this test.</p>
  </div>
<% end %>
