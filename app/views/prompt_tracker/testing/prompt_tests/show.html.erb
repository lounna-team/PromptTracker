<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item"><%= link_to "#{@prompt.name}-v#{@version.version_number}", testing_prompt_prompt_version_path(@prompt, @version) %></li>
  <li class="breadcrumb-item active"><%= @test.name %></li>
<% end %>

<%# Subscribe to Turbo Stream updates for this test %>
<%= turbo_stream_from "prompt_test_#{@test.id}" %>

<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-check2-square"></i> <%= @test.name %>
      <span class="badge bg-primary">v<%= @version.version_number %></span>
      <% unless @test.enabled? %>
        <span class="badge bg-secondary">Disabled</span>
      <% end %>
    </h1>
    <p class="text-muted"><%= @test.description %></p>
  </div>
  <div class="col-auto d-flex gap-2">
    <%= link_to edit_testing_prompt_prompt_version_prompt_test_path(@prompt, @version, @test), class: "btn btn-outline-secondary" do %>
      <i class="bi bi-pencil"></i> Edit
    <% end %>
    <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#runTestModal-<%= @test.id %>">
      <i class="bi bi-play-circle"></i> Run Test
    </button>
  </div>
</div>

<%= render "prompt_tracker/testing/prompt_tests/run_test_modal", test: @test, prompt: @prompt, version: @version %>

<!-- Test Stats -->
<div class="row mb-4">
  <div class="col-md-3">
    <%= render "test_status_card", test: @test %>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= number_to_percentage(@test.pass_rate, precision: 0) %></div>
      <div class="metric-label">
        Pass Rate
        <i class="bi bi-info-circle text-muted"
           data-bs-toggle="tooltip"
           data-bs-placement="top"
           title="Percentage of test runs that passed all evaluators and assertions"
           style="cursor: help;"></i>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= @recent_runs.count %></div>
      <div class="metric-label">Total Runs</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value">
        <% if @test.last_run_avg_score.present? %>
          <%= @test.last_run_avg_score.round(0) %>
        <% else %>
          N/A
        <% end %>
      </div>
      <div class="metric-label">
        Avg Score (Last Run)
        <i class="bi bi-info-circle text-muted"
           data-bs-toggle="tooltip"
           data-bs-placement="top"
           title="Average score (0-100) from all evaluators in the most recent test run"
           style="cursor: help;"></i>
      </div>
    </div>
  </div>
</div>

<!-- Test Configuration -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Test Configuration</h5>
      </div>
      <div class="card-body">
        <h6>Model Configuration</h6>
        <pre class="bg-light p-3 rounded"><code><%= JSON.pretty_generate(@test.model_config) %></code></pre>

        <% if @test.metadata.present? && @test.metadata.any? %>
          <h6 class="mt-3">Metadata</h6>
          <pre class="bg-light p-3 rounded"><code><%= JSON.pretty_generate(@test.metadata) %></code></pre>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">Evaluators</h5>
      </div>
      <div class="card-body">
        <% if @test.evaluator_configs.present? && @test.evaluator_configs.any? %>
          <% @test.evaluator_configs.each do |evaluator_config| %>
            <div class="mb-3 p-3 border rounded">
              <%
                # Get evaluator key from the evaluator_type class name
                evaluator_class_name = evaluator_config.evaluator_type
                evaluator_key = evaluator_class_name.demodulize.underscore.gsub('_evaluator', '')
                template_path = "prompt_tracker/evaluator_configs/templates/#{evaluator_key}"
              %>

              <% begin %>
                <%= render partial: template_path, locals: { config: evaluator_config.config } %>
              <% rescue ActionView::MissingTemplate %>
                <%# Fallback to JSON display if no template exists %>
                <h6><%= evaluator_config.evaluator_type.demodulize.titleize %></h6>
                <% if evaluator_config.config.present? %>
                  <p class="mb-0"><strong>Config:</strong></p>
                  <pre class="bg-light p-2 rounded mb-0"><code><%= JSON.pretty_generate(evaluator_config.config) %></code></pre>
                <% end %>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p class="text-muted">No evaluators configured</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Recent Test Runs -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">Recent Test Runs</h5>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm table-bordered bg-white mb-0">
        <thead>
          <tr>
            <th style="width: 10%;">Status</th>
            <th style="width: 12%;">Run Time</th>
            <th style="width: 10%;">Response Time</th>
            <th style="width: 8%;">Cost</th>
            <th style="width: 20%;">Rendered Prompt</th>
            <th style="width: 20%;">Response</th>
            <th style="width: 10%;">Evaluations</th>
            <th style="width: 10%;">Human Evaluations</th>
            <th style="width: 5%;">Actions</th>
          </tr>
        </thead>
        <tbody id="recent_runs_tbody">
          <% if @recent_runs.any? %>
            <% @recent_runs.each do |run| %>
              <%= render "test_run_row", run: run %>
            <% end %>
          <% else %>
            <tr id="no_runs_placeholder">
              <td colspan="9" class="text-center text-muted py-4">No test runs yet. Click "Run Test" to get started!</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modals (outside table structure) -->
<% if @recent_runs.any? %>
  <div data-controller="modal-fix">
    <!-- Evaluation Modals -->
    <% @recent_runs.each do |run| %>
      <% if run.llm_response&.evaluations&.any? %>
        <% run.llm_response.evaluations.each do |evaluation| %>
          <% template_name = evaluation.evaluator_key.to_s %>
          <% template_path = "prompt_tracker/evaluations/evaluators/#{template_name}" %>

          <div class="modal fade" id="evaluation-modal-<%= evaluation.id %>" tabindex="-1" aria-labelledby="evaluation-modal-label-<%= evaluation.id %>" aria-hidden="true" data-modal-fix-target="modal">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="evaluation-modal-label-<%= evaluation.id %>">
                    <i class="bi bi-clipboard-check"></i>
                    <%= evaluation.evaluator_key.to_s.titleize %> Evaluation
                    <% if evaluation.passed? %>
                      <span class="badge bg-success ms-2">PASSED</span>
                    <% else %>
                      <span class="badge bg-danger ms-2">FAILED</span>
                    <% end %>
                    <span class="badge bg-secondary ms-2">Score: <%= number_with_precision(evaluation.score, precision: 0) %></span>
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <% if lookup_context.exists?(template_path, [], true) %>
                    <%= render partial: template_path, locals: { evaluation: evaluation } %>
                  <% elsif evaluation.metadata.present? && evaluation.metadata.any? %>
                    <!-- Fallback: Raw Metadata Display -->
                    <div class="alert alert-warning">
                      <i class="bi bi-exclamation-triangle"></i>
                      <strong>No template found for evaluator:</strong> <%= evaluation.evaluator_key %>
                    </div>
                    <pre class="bg-light p-3 rounded"><code><%= JSON.pretty_generate(evaluation.metadata) %></code></pre>
                  <% else %>
                    <p class="text-muted">No evaluation details available.</p>
                  <% end %>
                </div>
                <div class="modal-footer">
                  <%= link_to "View Full Evaluation", evaluation_path(evaluation), class: "btn btn-primary", target: "_blank" %>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      <% end %>
    <% end %>

    <!-- Human Evaluation Modals -->
    <% @recent_runs.each do |run| %>
      <%= render "prompt_tracker/shared/human_evaluation_modal",
                 record: run,
                 form_url: testing_run_human_evaluations_path(run),
                 context: 'testing' %>
      <%= render "prompt_tracker/testing/prompt_tests/all_human_evaluations_modal",
                 run: run %>
    <% end %>
  </div>
<% end %>
