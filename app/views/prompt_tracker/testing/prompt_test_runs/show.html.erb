<% content_for :title, "Test Run ##{@test_run.id}" %>

<%# Subscribe to Turbo Stream updates for this test run %>
<% if @test_run.running? %>
  <%= turbo_stream_from "test_run_#{@test_run.id}" %>
<% end %>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><%= link_to "Test Runs", prompt_test_runs_path %></li>
    <li class="breadcrumb-item active">Run #<%= @test_run.id %></li>
  </ol>
</nav>

<!-- Header -->
<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-play-circle-fill"></i> Test Run #<%= @test_run.id %>
      <% if @test_run.running? %>
        <span class="badge bg-warning">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          Running...
        </span>
      <% elsif @test_run.passed? %>
        <span class="badge bg-success">Passed</span>
      <% elsif @test_run.status == 'error' %>
        <span class="badge bg-danger">Error</span>
      <% else %>
        <span class="badge bg-danger">Failed</span>
      <% end %>
    </h1>
    <p class="text-muted">
      Test: <%= link_to @test.name, testing_prompt_prompt_version_prompt_test_path(@test.prompt, @version, @test) %>
      | Version: <%= link_to "v#{@version.version_number}", testing_prompt_prompt_version_path(@test.prompt, @version) %>
      <% if @test_run.dataset.present? %>
        | Dataset: <%= link_to @test_run.dataset.name, testing_prompt_prompt_version_dataset_path(@test.prompt, @version, @test_run.dataset) %>
        <% if @test_run.dataset_row.present? %>
          (Row #<%= @test_run.dataset_row.id %>)
        <% end %>
      <% elsif @test_run.metadata["run_mode"] == "single" %>
        | <span class="badge bg-info">Single Run</span>
      <% end %>
      | Run at: <%= @test_run.created_at.strftime("%B %d, %Y at %I:%M %p") %>
    </p>
  </div>
  <div class="col-auto">
    <%= link_to testing_prompt_prompt_version_prompt_test_path(@test.prompt, @version, @test), class: "btn btn-outline-secondary" do %>
      <i class="bi bi-arrow-left"></i> Back to Test
    <% end %>
  </div>
</div>

<!-- Stats -->
<div class="row mb-4">
  <div class="col-md-2">
    <div class="card metric-card">
      <div class="metric-value">
        <% if @test_run.running? %>
          <span class="text-warning">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Running
          </span>
        <% elsif @test_run.passed? %>
          <span class="text-success">✓ Passed</span>
        <% elsif @test_run.status == 'error' %>
          <span class="text-danger">✗ Error</span>
        <% else %>
          <span class="text-danger">✗ Failed</span>
        <% end %>
      </div>
      <div class="metric-label">Status</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card metric-card">
      <div class="metric-value"><%= @test_run.execution_time_ms %>ms</div>
      <div class="metric-label">Execution Time</div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value">
        <span class="text-success"><%= @test_run.passed_evaluators || 0 %></span> /
        <span class="text-danger"><%= @test_run.failed_evaluators || 0 %></span>
      </div>
      <div class="metric-label">Evaluators (Pass/Fail)</div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card metric-card">
      <div class="metric-value">
        <% if @test_run.cost_usd && @test_run.cost_usd > 0 %>
          $<%= number_with_precision(@test_run.cost_usd, precision: 4) %>
        <% elsif @llm_response&.cost_usd && @llm_response.cost_usd > 0 %>
          $<%= number_with_precision(@llm_response.cost_usd, precision: 4) %>
        <% else %>
          <span class="text-muted">-</span>
        <% end %>
      </div>
      <div class="metric-label">Cost</div>
    </div>
  </div>
</div>

<!-- Running Message -->
<% if @test_run.running? %>
  <div class="alert alert-info mb-4">
    <h5>
      <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
      <i class="bi bi-hourglass-split"></i> Test Running
    </h5>
    <p class="mb-0">
      LLM response received. Evaluators are running in the background...
      <br>
      <small class="text-muted">This page will automatically update when the test completes.</small>
    </p>
  </div>
<% end %>

<!-- Error Message (if any) -->
<% if @test_run.error_message.present? %>
  <div class="alert alert-danger mb-4">
    <h5><i class="bi bi-exclamation-triangle"></i> Error</h5>
    <pre class="mb-0"><%= @test_run.error_message %></pre>
  </div>
<% end %>

<!-- Dataset Row Data (if applicable) -->
<% if @test_run.dataset_row.present? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-table"></i> Dataset Row Data
      </h5>
    </div>
    <div class="card-body">
      <p class="text-muted mb-3">
        Variables used from
        <%= link_to @test_run.dataset.name, testing_prompt_prompt_version_dataset_path(@test.prompt, @version, @test_run.dataset) %>
        (Row #<%= @test_run.dataset_row.id %>):
      </p>
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Variable</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          <% @test_run.dataset_row.row_data.each do |key, value| %>
            <tr>
              <td><code><%= key %></code></td>
              <td>
                <% if value.to_s.length > 100 %>
                  <details>
                    <summary><%= truncate(value, length: 100) %></summary>
                    <pre class="mt-2 mb-0"><%= value %></pre>
                  </details>
                <% else %>
                  <%= value %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% elsif @test_run.metadata["custom_variables"].present? %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">
        <i class="bi bi-pencil"></i> Custom Variables
      </h5>
    </div>
    <div class="card-body">
      <p class="text-muted mb-3">
        Manually entered variables for this single run:
      </p>
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Variable</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          <% @test_run.metadata["custom_variables"].each do |key, value| %>
            <tr>
              <td><code><%= key %></code></td>
              <td>
                <% if value.to_s.length > 100 %>
                  <details>
                    <summary><%= truncate(value, length: 100) %></summary>
                    <pre class="mt-2 mb-0"><%= value %></pre>
                  </details>
                <% else %>
                  <%= value %>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
<% end %>

<!-- LLM Response -->
<% if @llm_response %>
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">LLM Response</h5>
    </div>
    <div class="card-body">
      <h6>Rendered Prompt</h6>
      <pre class="bg-light p-3 rounded"><code><%= @llm_response.rendered_prompt %></code></pre>

      <h6 class="mt-3">Response</h6>
      <pre class="bg-light p-3 rounded"><code><%= @llm_response.response_text %></code></pre>

      <div class="row mt-3">
        <div class="col-md-6">
          <small class="text-muted">
            <strong>Provider:</strong> <%= @llm_response.provider %><br>
            <strong>Model:</strong> <%= @llm_response.model %>
          </small>
        </div>
        <div class="col-md-6 text-end">
          <small class="text-muted">
            <% if @llm_response.tokens_total %>
              <strong>Tokens:</strong> <%= @llm_response.tokens_total %>
              (<%= @llm_response.tokens_prompt %> prompt + <%= @llm_response.tokens_completion %> completion)
            <% end %>
          </small>
        </div>
      </div>
    </div>
  </div>
<% end %>

<!-- Evaluations -->
<%= render "prompt_tracker/shared/evaluations_table", evaluations: @test_run.evaluations, title: "Evaluations" %>

<!-- Test Configuration -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">Test Configuration</h5>
  </div>
  <div class="card-body">
    <div class="row">
      <div class="col-md-6">
        <h6>Template Variables</h6>
        <pre class="bg-light p-3 rounded"><code><%= JSON.pretty_generate(@test.template_variables) %></code></pre>
      </div>
      <div class="col-md-6">
        <h6>Model Configuration</h6>
        <pre class="bg-light p-3 rounded"><code><%= JSON.pretty_generate(@test.model_config) %></code></pre>
      </div>
    </div>

  </div>
</div>

<!-- Metadata -->
<% if @test_run.metadata.present? && @test_run.metadata.any? %>
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Run Metadata</h5>
    </div>
    <div class="card-body">
      <pre class="bg-light p-3 rounded mb-0"><code><%= JSON.pretty_generate(@test_run.metadata) %></code></pre>
    </div>
  </div>
<% end %>
