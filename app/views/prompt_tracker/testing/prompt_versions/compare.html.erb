<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item"><%= link_to "Testing", testing_root_path %></li>
  <li class="breadcrumb-item active">Compare Versions</li>
<% end %>

<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-arrow-left-right"></i> Compare Versions
    </h1>
    <p class="text-muted">Compare v<%= @version.version_number %> with another version</p>
  </div>
</div>

<!-- Version Selector -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: compare_testing_prompt_prompt_version_path(@prompt, @version), method: :get, local: true, class: "row g-3" do |f| %>
      <div class="col-md-5">
        <label class="form-label">Version A (Current)</label>
        <input type="text" class="form-control" value="v<%= @version.version_number %>" disabled>
      </div>

      <div class="col-md-5">
        <%= f.label :compare_with, "Version B (Compare With)", class: "form-label" %>
        <%= f.select :compare_with,
                     options_for_select(@all_versions.reject { |v| v.id == @version.id }.map { |v| ["v#{v.version_number}", v.id] }, params[:compare_with]),
                     {},
                     class: "form-select" %>
      </div>

      <div class="col-md-2">
        <label class="form-label">&nbsp;</label>
        <%= f.submit "Compare", class: "btn btn-primary w-100" %>
      </div>
    <% end %>
  </div>
</div>

<% if @compare_version %>
  <!-- Metrics Comparison -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <h6 class="text-muted">Total Calls</h6>
          <div class="row">
            <div class="col-6">
              <div class="metric-value text-primary"><%= @version_metrics[:calls] %></div>
              <small>v<%= @version.version_number %></small>
            </div>
            <div class="col-6">
              <div class="metric-value text-secondary"><%= @compare_metrics[:calls] %></div>
              <small>v<%= @compare_version.version_number %></small>
            </div>
          </div>
          <% if @metrics_diff[:calls] != 0 %>
            <div class="mt-2">
              <span class="badge bg-<%= @metrics_diff[:calls] > 0 ? 'success' : 'danger' %>">
                <%= @metrics_diff[:calls] > 0 ? '+' : '' %><%= @metrics_diff[:calls] %>
              </span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <h6 class="text-muted">Avg Response Time</h6>
          <div class="row">
            <div class="col-6">
              <div class="metric-value text-primary" style="font-size: 1.2rem;"><%= format_duration(@version_metrics[:avg_response_time]) %></div>
              <small>v<%= @version.version_number %></small>
            </div>
            <div class="col-6">
              <div class="metric-value text-secondary" style="font-size: 1.2rem;"><%= format_duration(@compare_metrics[:avg_response_time]) %></div>
              <small>v<%= @compare_version.version_number %></small>
            </div>
          </div>
          <% if @metrics_diff[:avg_response_time] != 0 %>
            <div class="mt-2">
              <span class="badge bg-<%= @metrics_diff[:avg_response_time] < 0 ? 'success' : 'danger' %>">
                <%= @metrics_diff[:avg_response_time] > 0 ? '+' : '' %><%= format_duration(@metrics_diff[:avg_response_time]) %>
              </span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <h6 class="text-muted">Total Cost</h6>
          <div class="row">
            <div class="col-6">
              <div class="metric-value text-primary" style="font-size: 1.2rem;"><%= format_cost(@version_metrics[:total_cost]) %></div>
              <small>v<%= @version.version_number %></small>
            </div>
            <div class="col-6">
              <div class="metric-value text-secondary" style="font-size: 1.2rem;"><%= format_cost(@compare_metrics[:total_cost]) %></div>
              <small>v<%= @compare_version.version_number %></small>
            </div>
          </div>
          <% if @metrics_diff[:total_cost] != 0 %>
            <div class="mt-2">
              <span class="badge bg-<%= @metrics_diff[:total_cost] < 0 ? 'success' : 'danger' %>">
                <%= @metrics_diff[:total_cost] > 0 ? '+' : '' %><%= format_cost(@metrics_diff[:total_cost]) %>
              </span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <h6 class="text-muted">Avg Quality Score</h6>
          <div class="row">
            <div class="col-6">
              <div class="metric-value text-primary"><%= @version_metrics[:avg_score].round(2) %></div>
              <small>v<%= @version.version_number %></small>
            </div>
            <div class="col-6">
              <div class="metric-value text-secondary"><%= @compare_metrics[:avg_score].round(2) %></div>
              <small>v<%= @compare_version.version_number %></small>
            </div>
          </div>
          <% if @metrics_diff[:avg_score] != 0 %>
            <div class="mt-2">
              <span class="badge bg-<%= @metrics_diff[:avg_score] > 0 ? 'success' : 'danger' %>">
                <%= @metrics_diff[:avg_score] > 0 ? '+' : '' %><%= @metrics_diff[:avg_score] %>
              </span>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Prompt Comparison -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Prompt Comparison</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6>v<%= @version.version_number %> <%= status_badge(@version.status) %></h6>
          <% if @version.system_prompt.present? %>
            <div class="mb-3">
              <div class="badge bg-secondary mb-2">System Prompt</div>
              <pre class="border-start border-3 border-secondary ps-3"><code><%= @version.system_prompt %></code></pre>
            </div>
          <% end %>
          <div>
            <div class="badge bg-primary mb-2">User Prompt</div>
            <pre class="border-start border-3 border-primary ps-3"><code><%= @version.user_prompt %></code></pre>
          </div>
        </div>
        <div class="col-md-6">
          <h6>v<%= @compare_version.version_number %> <%= status_badge(@compare_version.status) %></h6>
          <% if @compare_version.system_prompt.present? %>
            <div class="mb-3">
              <div class="badge bg-secondary mb-2">System Prompt</div>
              <pre class="border-start border-3 border-secondary ps-3"><code><%= @compare_version.system_prompt %></code></pre>
            </div>
          <% end %>
          <div>
            <div class="badge bg-primary mb-2">User Prompt</div>
            <pre class="border-start border-3 border-primary ps-3"><code><%= @compare_version.user_prompt %></code></pre>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Details Comparison -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Details Comparison</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Property</th>
              <th>v<%= @version.version_number %></th>
              <th>v<%= @compare_version.version_number %></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th>Status</th>
              <td><%= status_badge(@version.status) %></td>
              <td><%= status_badge(@compare_version.status) %></td>
            </tr>
            <tr>
              <th>Created</th>
              <td><%= format_timestamp(@version.created_at) %></td>
              <td><%= format_timestamp(@compare_version.created_at) %></td>
            </tr>
            <tr>
              <th>Updated</th>
              <td><%= format_timestamp(@version.updated_at) %></td>
              <td><%= format_timestamp(@compare_version.updated_at) %></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
<% else %>
  <div class="alert alert-info">
    <i class="bi bi-info-circle"></i> Select a version to compare with v<%= @version.version_number %>
  </div>
<% end %>
