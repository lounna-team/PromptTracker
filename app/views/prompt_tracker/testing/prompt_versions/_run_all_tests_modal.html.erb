<!-- Run All Tests Modal -->
<div class="modal fade" id="runAllTestsModal" tabindex="-1"
     data-controller="modal-fix run-test-modal"
     data-modal-fix-target="modal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Run All Tests</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <%= form_with(url: run_all_testing_prompt_prompt_version_prompt_tests_path(@prompt, @version),
                    method: :post) do |f| %>
        <div class="modal-body">
          <p class="text-muted mb-3">
            Choose how to run all <%= @tests.count %> test(s):
          </p>

          <!-- Run Mode Selection -->
          <div class="mb-4">
            <div class="form-check mb-3">
              <%= f.radio_button :run_mode, "dataset",
                  checked: true,
                  class: "form-check-input",
                  data: {
                    action: "change->run-test-modal#toggleMode",
                    "run-test-modal-target": "modeRadio"
                  } %>
              <%= f.label :run_mode_dataset, class: "form-check-label" do %>
                <strong>Run against dataset</strong>
                <small class="d-block text-muted">Execute each test for all rows in a dataset</small>
              <% end %>
            </div>

            <div class="form-check">
              <%= f.radio_button :run_mode, "single",
                  class: "form-check-input",
                  data: {
                    action: "change->run-test-modal#toggleMode",
                    "run-test-modal-target": "modeRadio"
                  } %>
              <%= f.label :run_mode_single, class: "form-check-label" do %>
                <strong>Single run with custom variables</strong>
                <small class="d-block text-muted">Execute each test once with manually entered values</small>
              <% end %>
            </div>
          </div>

          <!-- Dataset Selection (shown when run_mode=dataset) -->
          <div data-run-test-modal-target="datasetSection">
            <div class="mb-3">
              <%= f.label :dataset_id, "Select Dataset", class: "form-label" %>
              <%= f.select :dataset_id,
                  options_from_collection_for_select(@version.datasets, :id, :name),
                  { prompt: "Choose a dataset..." },
                  class: "form-select",
                  data: { "run-test-modal-target": "datasetSelect" } %>
              <small class="form-text text-muted">
                Each test will run once for each row in the selected dataset.
                Total runs: <%= @tests.count %> tests Ã— <span data-run-test-modal-target="rowCount">?</span> rows
              </small>
            </div>

            <% if @version.datasets.any? %>
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>Batch execution:</strong> This will create <%= @tests.count %> test runs per dataset row.
              </div>
            <% else %>
              <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                No datasets available for this prompt version.
                <%= link_to "Create a dataset", testing_prompt_prompt_version_datasets_path(@prompt, @version), class: "alert-link" %>
                to run tests against multiple data rows.
              </div>
            <% end %>
          </div>

          <!-- Custom Variables (shown when run_mode=single) -->
          <div data-run-test-modal-target="customSection" style="display: none;">
            <% if @version.variables_schema.present? %>
              <p class="text-muted mb-3">
                Enter values for the prompt variables (will be used for all tests):
              </p>

              <% @version.variables_schema.each do |var_name, var_config| %>
                <% var_config ||= {} %>
                <div class="mb-3">
                  <%= label_tag "custom_variables[#{var_name}]", var_name.to_s.humanize, class: "form-label" %>

                  <% if var_config["type"] == "text" %>
                    <%= text_area_tag "custom_variables[#{var_name}]",
                        nil,
                        class: "form-control",
                        rows: 3,
                        placeholder: var_config["description"] %>
                  <% else %>
                    <%= text_field_tag "custom_variables[#{var_name}]",
                        nil,
                        class: "form-control",
                        placeholder: var_config["description"] %>
                  <% end %>

                  <% if var_config["description"].present? %>
                    <small class="form-text text-muted"><%= var_config["description"] %></small>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                This prompt version has no variables defined.
              </div>
            <% end %>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <%= f.submit "Run All Tests", class: "btn btn-success", data: { "run-test-modal-target": "submitButton" } %>
        </div>
      <% end %>
    </div>
  </div>
</div>
