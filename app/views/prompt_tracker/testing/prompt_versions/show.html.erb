<%= turbo_stream_from "prompt_version_#{@version.id}" %>
<% @tests.each do |test| %>
  <%= turbo_stream_from "prompt_test_#{test.id}" %>
<% end %>

<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item"><%= link_to "Prompts", testing_prompts_path %></li>
  <li class="breadcrumb-item"><%= link_to @prompt.name, testing_prompt_path(@prompt) %></li>
  <li class="breadcrumb-item active">v<%= @version.version_number %></li>
<% end %>

<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-file-code"></i> <%= @prompt.name %>
      <span class="badge bg-primary">v<%= @version.version_number %></span>
      <%= status_badge(@version.status) %>
    </h1>
    <p class="text-muted">
      <%= @prompt.description %>
      <span class="ms-3"><i class="bi bi-calendar"></i> Created <%= format_timestamp(@version.created_at) %></span>
    </p>
  </div>
  <div class="col-auto d-flex gap-2">
    <% unless @version.active? %>
      <%= button_to activate_testing_prompt_prompt_version_path(@prompt, @version), method: :post, class: "btn btn-success", data: { confirm: "Activate this version? This will deprecate all other versions." } do %>
        <i class="bi bi-check-circle"></i> Activate Version
      <% end %>
    <% end %>
    <%= link_to testing_prompt_prompt_version_playground_path(@prompt, @version), class: "btn btn-primary" do %>
      <i class="bi bi-pencil-square"></i> Edit in Playground
    <% end %>
    <%= link_to compare_testing_prompt_prompt_version_path(@prompt, @version), class: "btn btn-outline-info" do %>
      <i class="bi bi-arrow-left-right"></i> Compare Versions
    <% end %>
  </div>
</div>

<!-- Test Metrics -->
<div class="alert alert-info mb-4">
  <i class="bi bi-info-circle"></i>
  <strong>Test Environment Metrics:</strong> The metrics below reflect only test runs from this version, not production usage.
  For production monitoring, see the <a href="<%= monitoring_root_path %>" class="alert-link">Monitoring</a> section.
</div>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value">
        <% if @total_tests == 0 %>
          <span class="text-muted">No Tests</span>
        <% elsif @tests_failing == 0 %>
          <span class="text-success"><i class="bi bi-check-circle-fill"></i> Passing</span>
        <% elsif @tests_passing == 0 %>
          <span class="text-danger"><i class="bi bi-x-circle-fill"></i> Failing</span>
        <% else %>
          <span class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> Partial</span>
        <% end %>
      </div>
      <div class="metric-label">Test Suite Status</div>
      <small class="text-muted d-block mt-1">
        <% if @total_tests > 0 %>
          <%= @tests_passing %> passing, <%= @tests_failing %> failing
        <% else %>
          Create tests to validate quality
        <% end %>
      </small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= format_cost(@total_cost) %></div>
      <div class="metric-label">Test Cost</div>
      <small class="text-muted d-block mt-1">From test runs</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value"><%= format_duration(@avg_response_time) %></div>
      <div class="metric-label">Avg Response Time</div>
      <small class="text-muted d-block mt-1">Test runs average</small>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card metric-card">
      <div class="metric-value">
        <% if @total_tests > 0 %>
          <span class="text-success"><%= @tests_passing %></span> / <span class="text-danger"><%= @tests_failing %></span>
        <% else %>
          <span class="text-muted">No tests</span>
        <% end %>
      </div>
      <div class="metric-label">Tests Passing / Failing</div>
      <small class="text-muted d-block mt-1">
        <% if @total_tests > 0 %>
          <%= ((@tests_passing.to_f / @total_tests) * 100).round(1) %>% pass rate
        <% else %>
          Create tests to track quality
        <% end %>
      </small>
    </div>
  </div>
</div>

<!-- Template & Model Config -->
<div class="row mb-4">
  <div class="col-md-<%= @version.model_config.present? && @version.model_config.any? ? '8' : '12' %>">
    <div class="card h-100">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="bi bi-file-text"></i> Template</h6>
        <span class="badge bg-secondary"><%= @version.template.length %> chars</span>
      </div>
      <div class="card-body">
        <pre class="mb-0" style="max-height: 300px; overflow-y: auto;"><code><%= @version.template %></code></pre>
      </div>
    </div>
  </div>
  <% if @version.model_config.present? && @version.model_config.any? %>
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header">
          <h6 class="mb-0"><i class="bi bi-gear"></i> Model Config</h6>
        </div>
        <div class="card-body">
          <% @version.model_config.each do |key, value| %>
            <div class="mb-2">
              <small class="text-muted d-block"><%= key.to_s.titleize %></small>
              <strong><%= value %></strong>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Tests -->
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Tests</h5>
    <div>
      <span class="badge bg-secondary me-2"><%= @tests.count %> tests</span>
      <% if @tests.any? %>
        <%= button_to run_all_testing_prompt_prompt_version_prompt_tests_path(@prompt, @version), method: :post, class: "btn btn-sm btn-success me-2", data: { turbo_stream: true } do %>
          <i class="bi bi-play-circle"></i> Run All
        <% end %>
      <% end %>
      <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#new-test-modal">
        <i class="bi bi-plus-circle"></i> New Test
      </button>
    </div>
  </div>
  <div class="card-body">
    <% if @tests.any? %>
      <%= render "prompt_tracker/testing/prompt_versions/tests_table", tests: @tests, prompt: @prompt, version: @version %>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-clipboard-check" style="font-size: 3rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No tests yet for this version</p>
        <p class="text-muted">Tests help you validate prompt behavior before deploying to production.</p>
        <%= link_to "Create Your First Test", new_testing_prompt_prompt_version_prompt_test_path(@prompt, @version), class: "btn btn-primary mt-2" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Evaluation Modals (outside table structure) -->
<% if @tests.any? %>
  <% @tests.each do |test| %>
    <%= render "prompt_tracker/testing/prompt_tests/evaluation_modals", test: test %>
    <%= render "prompt_tracker/testing/prompt_tests/evaluator_config_modals", test: test %>
  <% end %>
<% end %>

<!-- Auto-Evaluators Configuration -->
<div class="row mb-4">
  <div class="col-12">
    <%= render "evaluator_configs" %>
  </div>
</div>

<!-- Evaluator Modals (outside card to avoid z-index issues) -->
<%= render "evaluator_modals" %>

<!-- New Test Modal -->
<div class="modal fade" id="new-test-modal" tabindex="-1" aria-labelledby="new-test-modal-label" aria-hidden="true" data-controller="modal-fix" data-modal-fix-target="modal">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="new-test-modal-label">
          <i class="bi bi-plus-circle"></i> Create New Test
          <span class="badge bg-primary">v<%= @version.version_number %></span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <%= render "prompt_tracker/testing/prompt_tests/form", prompt: @prompt, version: @version, test: PromptTracker::PromptTest.new(prompt_version: @version, enabled: true) %>
      </div>
    </div>
  </div>
</div>
