<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item active">Prompts</li>
<% end %>

<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-file-text"></i> Prompts
      <span class="badge bg-secondary"><%= @prompts.total_count %></span>
    </h1>
    <p class="text-muted">Browse and search all LLM prompts</p>
  </div>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: prompts_path, method: :get, local: true, class: "row g-3" do |f| %>
      <div class="col-md-4">
        <%= f.label :q, "Search", class: "form-label" %>
        <%= f.text_field :q, value: params[:q], class: "form-control", placeholder: "Search by name or description..." %>
      </div>

      <div class="col-md-2">
        <%= f.label :category, "Category", class: "form-label" %>
        <%= f.select :category, options_for_select([["All", ""]] + @categories.map { |c| [c, c] }, params[:category]), {}, class: "form-select" %>
      </div>

      <div class="col-md-2">
        <%= f.label :tag, "Tag", class: "form-label" %>
        <%= f.select :tag, options_for_select([["All", ""]] + @tags.map { |t| [t, t] }, params[:tag]), {}, class: "form-select" %>
      </div>

      <div class="col-md-2">
        <%= f.label :status, "Status", class: "form-label" %>
        <%= f.select :status, options_for_select([["All", ""], ["Active", "active"], ["Archived", "archived"]], params[:status]), {}, class: "form-select" %>
      </div>

      <div class="col-md-2">
        <%= f.label :sort, "Sort By", class: "form-label" %>
        <%= f.select :sort, options_for_select([["Recent", ""], ["Name", "name"], ["Most Calls", "calls"], ["Highest Cost", "cost"]], params[:sort]), {}, class: "form-select" %>
      </div>

      <div class="col-12">
        <%= f.submit "Apply Filters", class: "btn btn-primary" %>
        <%= link_to "Clear", prompts_path, class: "btn btn-outline-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Prompts Table -->
<div class="card">
  <div class="card-body">
    <% if @prompts.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Name</th>
              <th>Description</th>
              <th>Category</th>
              <th>Tags</th>
              <th>Active Version</th>
              <th class="text-end">Total Calls</th>
              <th class="text-end">Total Cost</th>
              <th class="text-end">Avg Score</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @prompts.each do |prompt| %>
              <tr>
                <td>
                  <strong><%= link_to prompt.name, prompt_path(prompt) %></strong>
                  <% if prompt.archived_at.present? %>
                    <span class="badge bg-dark ms-2">Archived</span>
                  <% end %>
                </td>
                <td><%= truncate_text(prompt.description, 80) %></td>
                <td>
                  <% if prompt.category.present? %>
                    <span class="badge bg-info"><%= prompt.category %></span>
                  <% end %>
                </td>
                <td>
                  <% if prompt.tags.present? %>
                    <% prompt.tags.first(3).each do |tag| %>
                      <span class="badge bg-secondary"><%= tag %></span>
                    <% end %>
                    <% if prompt.tags.length > 3 %>
                      <span class="badge bg-light text-dark">+<%= prompt.tags.length - 3 %></span>
                    <% end %>
                  <% end %>
                </td>
                <td>
                  <% if prompt.active_version %>
                    <%= status_badge(prompt.active_version.status) %>
                    v<%= prompt.active_version.version_number %>
                  <% else %>
                    <span class="text-muted">None</span>
                  <% end %>
                </td>
                <td class="text-end">
                  <%= format_tokens(prompt.total_llm_calls) %>
                </td>
                <td class="text-end">
                  <%= format_cost(prompt.total_cost_usd) %>
                </td>
                <td class="text-end">
                  <%
                    # Calculate average score across all evaluations
                    if prompt.evaluations.any?
                      normalized_scores = prompt.evaluations.map do |eval|
                        PromptTracker::EvaluationHelpers.normalize_score(eval.score, min: eval.score_min, max: eval.score_max)
                      end
                      avg_score = (normalized_scores.sum / normalized_scores.length.to_f * 100).round(1)
                  %>
                    <%= score_badge(avg_score, 0, 100) %>
                  <% else %>
                    <span class="text-muted">N/A</span>
                  <% end %>
                </td>
                <td>
                  <%= link_to "View", prompt_path(prompt), class: "btn btn-sm btn-outline-primary" %>
                  <%= link_to "Analytics", analytics_prompt_path(prompt), class: "btn btn-sm btn-outline-info" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="mt-3">
        <%= paginate @prompts %>
      </div>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-inbox" style="font-size: 3rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No prompts found</p>
        <% if params[:q].present? || params[:category].present? || params[:tag].present? %>
          <%= link_to "Clear filters", prompts_path, class: "btn btn-outline-primary" %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
