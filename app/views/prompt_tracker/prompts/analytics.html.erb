<% content_for :breadcrumbs do %>
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><%= link_to "Prompts", prompts_path %></li>
      <li class="breadcrumb-item"><%= link_to @prompt.name, prompt_path(@prompt) %></li>
      <li class="breadcrumb-item active" aria-current="page">Analytics</li>
    </ol>
  </nav>
<% end %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>
    <i class="bi bi-graph-up"></i>
    Analytics: <%= @prompt.name %>
  </h1>
  <%= link_to prompt_path(@prompt), class: "btn btn-outline-secondary" do %>
    <i class="bi bi-arrow-left"></i> Back to Prompt
  <% end %>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <h6 class="text-muted mb-2"><i class="bi bi-file-code"></i> Versions</h6>
        <h3 class="mb-0"><%= @versions.count %></h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <h6 class="text-muted mb-2"><i class="bi bi-chat-left-text"></i> Total Calls</h6>
        <h3 class="mb-0"><%= format_tokens(@prompt.llm_responses.count) %></h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <h6 class="text-muted mb-2"><i class="bi bi-currency-dollar"></i> Total Cost</h6>
        <h3 class="mb-0"><%= format_cost(@prompt.llm_responses.sum(:cost_usd)) %></h3>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <h6 class="text-muted mb-2"><i class="bi bi-clock"></i> Avg Response Time</h6>
        <h3 class="mb-0"><%= format_duration(@prompt.llm_responses.average(:response_time_ms)) %></h3>
      </div>
    </div>
  </div>
</div>

<!-- Version Comparison Table -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Version Performance Comparison</h5>
  </div>
  <div class="card-body">
    <% if @version_stats.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Version</th>
              <th>Status</th>
              <th class="text-end">Calls</th>
              <th class="text-end">Avg Response Time</th>
              <th class="text-end">Total Cost</th>
              <th class="text-end">Avg Score</th>
            </tr>
          </thead>
          <tbody>
            <% @version_stats.each do |stats| %>
              <tr class="<%= 'table-primary' if stats[:version] == @active_version %>">
                <td>
                  <%= link_to "v#{stats[:version].version_number}", prompt_prompt_version_path(@prompt, stats[:version]) %>
                  <% if stats[:version] == @active_version %>
                    <span class="badge bg-success ms-2">Active</span>
                  <% end %>
                </td>
                <td><%= status_badge(stats[:version].status) %></td>
                <td class="text-end"><%= format_tokens(stats[:calls]) %></td>
                <td class="text-end"><%= format_duration(stats[:avg_response_time]) %></td>
                <td class="text-end"><%= format_cost(stats[:total_cost]) %></td>
                <td class="text-end">
                  <% if stats[:has_evaluations] %>
                    <% avg_score = PromptTracker::EvaluationHelpers.average_score_for_version(stats[:version]) rescue nil %>
                    <%= score_badge(avg_score) if avg_score %>
                  <% else %>
                    <span class="text-muted">N/A</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <div class="text-center text-muted py-4">
        <i class="bi bi-bar-chart" style="font-size: 3rem;"></i>
        <p class="mt-3">No version statistics available yet.</p>
      </div>
    <% end %>
  </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
  <!-- Responses Over Time -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Responses Over Time (Last 30 Days)</h5>
      </div>
      <div class="card-body">
        <% if @responses_by_day.any? %>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th class="text-end">Responses</th>
                </tr>
              </thead>
              <tbody>
                <% @responses_by_day.sort.reverse.each do |date, count| %>
                  <tr>
                    <td><%= date.strftime("%Y-%m-%d") %></td>
                    <td class="text-end"><%= count %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center text-muted py-4">
            <p>No data for the last 30 days</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Cost Over Time -->
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Cost Over Time (Last 30 Days)</h5>
      </div>
      <div class="card-body">
        <% if @cost_by_day.any? %>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th class="text-end">Cost</th>
                </tr>
              </thead>
              <tbody>
                <% @cost_by_day.sort.reverse.each do |date, cost| %>
                  <tr>
                    <td><%= date.strftime("%Y-%m-%d") %></td>
                    <td class="text-end"><%= format_cost(cost) %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center text-muted py-4">
            <p>No data for the last 30 days</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Provider Breakdown -->
<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Responses by Provider</h5>
      </div>
      <div class="card-body">
        <% if @responses_by_provider.any? %>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Provider</th>
                  <th class="text-end">Responses</th>
                  <th class="text-end">Percentage</th>
                </tr>
              </thead>
              <tbody>
                <% total_responses = @responses_by_provider.values.sum %>
                <% @responses_by_provider.sort_by { |_, count| -count }.each do |provider, count| %>
                  <tr>
                    <td><%= provider_icon(provider) %> <%= provider %></td>
                    <td class="text-end"><%= count %></td>
                    <td class="text-end"><%= ((count.to_f / total_responses * 100).round(1)) %>%</td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center text-muted py-4">
            <p>No provider data available</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-currency-dollar"></i> Cost by Provider</h5>
      </div>
      <div class="card-body">
        <% if @cost_by_provider.any? %>
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Provider</th>
                  <th class="text-end">Total Cost</th>
                  <th class="text-end">Percentage</th>
                </tr>
              </thead>
              <tbody>
                <% total_cost = @cost_by_provider.values.sum %>
                <% @cost_by_provider.sort_by { |_, cost| -cost }.each do |provider, cost| %>
                  <tr>
                    <td><%= provider_icon(provider) %> <%= provider %></td>
                    <td class="text-end"><%= format_cost(cost) %></td>
                    <td class="text-end"><%= ((cost.to_f / total_cost * 100).round(1)) %>%</td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% else %>
          <div class="text-center text-muted py-4">
            <p>No cost data available</p>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

