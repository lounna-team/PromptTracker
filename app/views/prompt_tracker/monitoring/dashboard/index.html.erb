<div class="monitoring-dashboard">
  <div class="page-header" style="background-color: #ECFDF5; border-left: 4px solid #10B981; padding: 1.5rem; margin-bottom: 2rem;">
    <h1 style="color: #065F46; margin: 0;">
      üìä Monitoring Dashboard
    </h1>
    <p style="color: #065F46; margin: 0.5rem 0 0 0;">
      Production LLM call tracking and quality monitoring
    </p>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
    <div class="stat-card" style="background: white; border: 2px solid #D1FAE5; border-radius: 8px; padding: 1.5rem;">
      <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">Calls (24h)</div>
      <div style="color: #10B981; font-size: 2rem; font-weight: bold;"><%= @calls_today %></div>
    </div>

    <div class="stat-card" style="background: white; border: 2px solid #D1FAE5; border-radius: 8px; padding: 1.5rem;">
      <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">Evaluations (24h)</div>
      <div style="color: #10B981; font-size: 2rem; font-weight: bold;"><%= @evaluations_today %></div>
    </div>

    <div class="stat-card" style="background: white; border: 2px solid #D1FAE5; border-radius: 8px; padding: 1.5rem;">
      <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">Avg Score (24h)</div>
      <div style="color: <%= @avg_score >= 0.7 ? '#10B981' : '#EF4444' %>; font-size: 2rem; font-weight: bold;">
        <%= @avg_score %>
      </div>
    </div>

    <div class="stat-card" style="background: white; border: 2px solid #D1FAE5; border-radius: 8px; padding: 1.5rem;">
      <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">Failing Evals (24h)</div>
      <div style="color: <%= @failing_evaluations.count > 0 ? '#EF4444' : '#10B981' %>; font-size: 2rem; font-weight: bold;">
        <%= @failing_evaluations.count %>
      </div>
    </div>
  </div>

  <!-- Alerts: Failing Evaluations -->
  <% if @failing_evaluations.any? %>
    <div style="background: #FEF2F2; border: 2px solid #FEE2E2; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
      <h2 style="color: #991B1B; margin-top: 0;">‚ö†Ô∏è Alerts: Low-Scoring Evaluations</h2>

      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="border-bottom: 2px solid #FEE2E2;">
            <th style="text-align: left; padding: 0.75rem; color: #64748B;">Response</th>
            <th style="text-align: left; padding: 0.75rem; color: #64748B;">Evaluator</th>
            <th style="text-align: left; padding: 0.75rem; color: #64748B;">Score</th>
            <th style="text-align: left; padding: 0.75rem; color: #64748B;">Time</th>
          </tr>
        </thead>
        <tbody>
          <% @failing_evaluations.each do |evaluation| %>
            <tr style="border-bottom: 1px solid #FEE2E2;">
              <td style="padding: 0.75rem;">
                <%= link_to "Response ##{evaluation.llm_response.id}", monitoring_response_path(evaluation.llm_response), style: "color: #DC2626; text-decoration: none;" %>
              </td>
              <td style="padding: 0.75rem; color: #64748B;"><%= evaluation.evaluator_id %></td>
              <td style="padding: 0.75rem;">
                <span style="color: #DC2626; font-weight: bold;"><%= evaluation.score.round(2) %></span>
              </td>
              <td style="padding: 0.75rem; color: #64748B;"><%= time_ago_in_words(evaluation.created_at) %> ago</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>

  <!-- Recent Tracked Responses -->
  <div style="background: white; border: 2px solid #D1FAE5; border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem;">
    <h2 style="color: #065F46; margin-top: 0;">Recent Tracked Calls</h2>

    <!-- Filters -->
    <div style="background: #F9FAFB; border: 1px solid #E5E7EB; border-radius: 6px; padding: 1rem; margin-bottom: 1.5rem;">
      <%= form_with url: monitoring_root_path, method: :get, local: true, style: "margin: 0;" do |f| %>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
          <!-- Prompt Filter -->
          <div>
            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">
              Prompt
            </label>
            <%= f.select :prompt_id,
                options_for_select([["All Prompts", ""]] + @prompts.map { |p| [p.name, p.id] }, params[:prompt_id]),
                {},
                style: "width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.875rem;" %>
          </div>

          <!-- Environment Filter -->
          <div>
            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">
              Environment
            </label>
            <%= f.select :environment,
                options_for_select([["All Environments", ""]] + @environments.map { |e| [e, e] }, params[:environment]),
                {},
                style: "width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.875rem;" %>
          </div>

          <!-- Status Filter -->
          <div>
            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">
              Status
            </label>
            <%= f.select :status,
                options_for_select([["All Statuses", ""]] + @statuses.map { |s| [s.titleize, s] }, params[:status]),
                {},
                style: "width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.875rem;" %>
          </div>

          <!-- Evaluator Type Filter -->
          <div>
            <label style="display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;">
              Evaluator Type
            </label>
            <%= f.select :evaluator_type,
                options_for_select([["All Types", ""]] + @evaluator_types.map { |t| [t.titleize, t] }, params[:evaluator_type]),
                {},
                style: "width: 100%; padding: 0.5rem; border: 1px solid #D1D5DB; border-radius: 4px; font-size: 0.875rem;" %>
          </div>

          <!-- Action Buttons -->
          <div style="display: flex; gap: 0.5rem;">
            <%= f.submit "Apply Filters", style: "background-color: #10B981; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; font-size: 0.875rem; cursor: pointer; font-weight: 500;" %>
            <%= link_to "Clear", monitoring_root_path, style: "background-color: #6B7280; color: white; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.875rem; text-decoration: none; display: inline-block; font-weight: 500;" %>
          </div>
        </div>
      <% end %>
    </div>

    <% if @recent_responses.any? %>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 2px solid #D1FAE5;">
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 120px;">Prompt</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 200px;">Rendered Prompt</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 200px;">Response</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 150px;">Evaluations</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 80px;">Env</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 80px;">Status</th>
              <th style="text-align: left; padding: 0.75rem; color: #64748B; min-width: 100px;">Time</th>
            </tr>
          </thead>
          <tbody>
            <% @recent_responses.each do |response| %>
              <tr style="border-bottom: 1px solid #F1F5F9;">
                <!-- Prompt Name -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <%= link_to response.prompt_version.prompt.name, monitoring_response_path(response), style: "color: #10B981; text-decoration: none; font-weight: 500;" %>
                  <br>
                  <small style="color: #94A3B8;">v<%= response.prompt_version.version_number %></small>
                </td>

                <!-- Rendered Prompt (truncated) -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <div style="max-width: 300px; font-size: 0.875rem; color: #475569; line-height: 1.4;">
                    <%= truncate_text(response.rendered_prompt, 150) %>
                  </div>
                </td>

                <!-- Response Text (truncated) -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <div style="max-width: 300px; font-size: 0.875rem; color: #475569; line-height: 1.4;">
                    <% if response.status == 'success' && response.response_text.present? %>
                      <%= truncate_text(response.response_text, 150) %>
                    <% elsif response.status == 'error' %>
                      <span style="color: #DC2626; font-style: italic;">
                        Error: <%= truncate_text(response.error_message || 'Unknown error', 100) %>
                      </span>
                    <% else %>
                      <span style="color: #94A3B8; font-style: italic;">No response</span>
                    <% end %>
                  </div>
                </td>

                <!-- Evaluations Breakdown -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <% tracked_evals = response.evaluations.tracked %>
                  <% if tracked_evals.any? %>
                    <div style="font-size: 0.875rem;">
                      <div style="margin-bottom: 0.25rem;">
                        <strong style="color: #374151;"><%= tracked_evals.count %> evaluation<%= tracked_evals.count == 1 ? '' : 's' %></strong>
                      </div>
                      <% tracked_evals.group_by(&:evaluator_type).each do |type, evals| %>
                        <div style="margin-bottom: 0.25rem;">
                          <span style="padding: 0.125rem 0.5rem; border-radius: 3px; font-size: 0.75rem; background-color: <%= type == 'automated' ? '#DBEAFE' : (type == 'llm_judge' ? '#E0E7FF' : '#FEF3C7') %>; color: <%= type == 'automated' ? '#1E40AF' : (type == 'llm_judge' ? '#4338CA' : '#92400E') %>;">
                            <%= type %>
                          </span>
                          <span style="color: #64748B; font-size: 0.75rem;">√ó <%= evals.count %></span>
                        </div>
                        <% evals.each do |eval| %>
                          <div style="margin-left: 0.5rem; font-size: 0.75rem; color: #64748B;">
                            ‚Ä¢ <%= eval.evaluator_id.split('_').first(2).join(' ').titleize %>:
                            <span style="font-weight: 600; color: <%= eval.score >= 0.7 ? '#10B981' : '#EF4444' %>;">
                              <%= eval.score.round(2) %>
                            </span>
                          </div>
                        <% end %>
                      <% end %>
                    </div>
                  <% else %>
                    <span style="color: #94A3B8; font-size: 0.875rem; font-style: italic;">No evals</span>
                  <% end %>
                </td>

                <!-- Environment -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; background-color: #F3F4F6; color: #374151; white-space: nowrap;">
                    <%= response.environment %>
                  </span>
                </td>

                <!-- Status -->
                <td style="padding: 0.75rem; vertical-align: top;">
                  <span style="padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; background-color: <%= response.status == 'success' ? '#D1FAE5' : '#FEE2E2' %>; color: <%= response.status == 'success' ? '#065F46' : '#991B1B' %>; white-space: nowrap;">
                    <%= response.status %>
                  </span>
                </td>

                <!-- Time -->
                <td style="padding: 0.75rem; color: #64748B; font-size: 0.875rem; vertical-align: top; white-space: nowrap;">
                  <%= time_ago_in_words(response.created_at) %> ago
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% else %>
      <p style="color: #64748B;">No tracked calls yet.</p>
    <% end %>
  </div>
</div>
