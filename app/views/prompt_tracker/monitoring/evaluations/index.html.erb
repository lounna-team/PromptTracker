<% content_for :breadcrumbs do %>
  <li class="breadcrumb-item active">Evaluations</li>
<% end %>

<div class="row mb-4">
  <div class="col">
    <h1>
      <i class="bi bi-clipboard-check"></i> Tracked Call Evaluations
    </h1>
    <p class="text-muted">Evaluations from tracked LLM calls in your application</p>
  </div>
</div>

<!-- Filters -->
<div class="card mb-4">
  <div class="card-body">
    <%= form_with url: request.path, method: :get, local: true, class: "row g-3", id: "filter-form" do |f| %>
      <div class="col-md-3">
        <%= label_tag :prompt_id, "Prompt", class: "form-label" %>
        <%= select_tag :prompt_id,
                       options_for_select([["All Prompts", ""]] + @prompts.map { |p| [p.name, p.id] }, params[:prompt_id]),
                       class: "form-select",
                       onchange: "this.form.submit();" %>
      </div>
      <div class="col-md-3">
        <%= label_tag :prompt_version_id, "Prompt Version", class: "form-label" %>
        <%= select_tag :prompt_version_id,
                       options_for_select([["All Versions", ""]] + @prompt_versions.map { |v| ["v#{v.version_number}", v.id] }, params[:prompt_version_id]),
                       class: "form-select",
                       disabled: @prompt_versions.empty? %>
      </div>
      <div class="col-md-3">
        <%= label_tag :evaluator_type, "Evaluator Type", class: "form-label" %>
        <%= select_tag :evaluator_type,
                       options_for_select([
                         ["All Types", ""],
                         ["Human", "human"],
                         ["LLM Judge", "llm_judge"],
                         ["Automated", "automated"]
                       ], params[:evaluator_type]),
                       class: "form-select" %>
      </div>
      <div class="col-md-3">
        <%= label_tag :min_score, "Min Score", class: "form-label" %>
        <%= number_field_tag :min_score, params[:min_score],
                             class: "form-control",
                             step: 0.1,
                             min: 0,
                             max: 1,
                             placeholder: "0.0" %>
      </div>
      <div class="col-md-3">
        <%= label_tag :max_score, "Max Score", class: "form-label" %>
        <%= number_field_tag :max_score, params[:max_score],
                             class: "form-control",
                             step: 0.1,
                             min: 0,
                             max: 1,
                             placeholder: "1.0" %>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <%= submit_tag "Filter", class: "btn btn-success me-2" %>
        <%= link_to "Clear", request.path, class: "btn btn-outline-secondary" %>
      </div>
    <% end %>
  </div>
</div>

<!-- Evaluations List -->
<div class="card">
  <div class="card-header">
    <h5 class="mb-0">All Evaluations</h5>
  </div>
  <div class="card-body">
    <% if @evaluations.any? %>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Response</th>
              <th>Prompt Version</th>
              <th>Evaluator</th>
              <th>Score</th>
              <th>Passed</th>
              <th>Evaluated At</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% @evaluations.each do |evaluation| %>
              <tr>
                <td>
                  <% if evaluation.llm_response %>
                    <%= link_to "Response ##{evaluation.llm_response.id}",
                                llm_response_path(evaluation.llm_response) %>
                  <% else %>
                    <span class="text-muted">No response</span>
                  <% end %>
                </td>
                <td>
                  <% if evaluation.prompt_version && evaluation.prompt %>
                    <%= link_to prompt_prompt_version_path(evaluation.prompt, evaluation.prompt_version) do %>
                      <strong><%= evaluation.prompt.name %></strong>
                      <br>
                      <small class="text-muted">v<%= evaluation.prompt_version.version_number %></small>
                    <% end %>
                  <% else %>
                    <span class="text-muted">Unknown</span>
                  <% end %>
                </td>
                <td>
                  <% case evaluation.evaluator_type %>
                  <% when "human" %>
                    <span class="badge bg-primary">Human</span>
                  <% when "llm_judge" %>
                    <span class="badge bg-info">LLM Judge</span>
                  <% when "automated" %>
                    <span class="badge bg-secondary">Automated</span>
                  <% else %>
                    <span class="badge bg-light text-dark"><%= evaluation.evaluator_type %></span>
                  <% end %>
                  <% if evaluation.evaluator_id.present? %>
                    <br><small class="text-muted"><%= evaluation.evaluator_id %></small>
                  <% end %>
                </td>
                <td>
                  <% score_color = evaluation.score >= 0.7 ? "text-success" : "text-danger" %>
                  <strong class="<%= score_color %>">
                    <%= number_with_precision(evaluation.score, precision: 2) %>
                  </strong>
                  <% if evaluation.score_max && evaluation.score_max != 1 %>
                    <small class="text-muted">/ <%= evaluation.score_max %></small>
                  <% end %>
                </td>
                <td>
                  <% if evaluation.passing? %>
                    <span class="badge bg-success">✓ Passed</span>
                  <% else %>
                    <span class="badge bg-danger">✗ Failed</span>
                  <% end %>
                </td>
                <td>
                  <%= time_ago_in_words(evaluation.created_at) %> ago
                </td>
                <td>
                  <%= link_to "View", monitoring_evaluation_path(evaluation), class: "btn btn-sm btn-outline-primary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if @evaluations.respond_to?(:total_pages) && @evaluations.total_pages > 1 %>
        <div class="mt-3">
          <%= paginate @evaluations %>
        </div>
      <% end %>
    <% else %>
      <div class="text-center py-5">
        <i class="bi bi-clipboard-check" style="font-size: 4rem; color: #ccc;"></i>
        <p class="text-muted mt-3">No evaluations found.</p>
        <% if params[:evaluator_type].present? || params[:min_score].present? || params[:max_score].present? %>
          <p class="text-muted">Try adjusting your filters.</p>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
